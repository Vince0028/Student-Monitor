<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#2563eb">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>{% block title %}Student Portal - Student Monitor{% endblock %}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/student_style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" />
    <style>
    html, body {
        height: 100%;
        min-height: 100vh;
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        -webkit-text-size-adjust: 100%;
        -ms-text-size-adjust: 100%;
    }
    body {
        display: flex;
        flex-direction: column;
        min-height: 100vh;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        line-height: 1.6;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
    }
    main.student-main {
        flex: 1 0 auto;
        width: 100%;
    }
    .student-footer {
        width: 100%;
        background: #1769c4;
        color: #fff;
        text-align: center;
        padding: 0.7rem 0 0.5rem 0;
        font-size: 0.9rem;
        z-index: 10;
        flex-shrink: 0;
    }
    
    /* Mobile Navigation Styles */
    .mobile-nav-toggle {
        display: none;
        background: none;
        border: none;
        color: white;
        font-size: 1.5rem;
        cursor: pointer;
        padding: 0.5rem;
        border-radius: 4px;
        transition: background-color 0.2s;
    }
    
    .mobile-nav-toggle:hover {
        background-color: rgba(255, 255, 255, 0.1);
    }
    
    .mobile-nav-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 998;
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    
    .mobile-nav-overlay.active {
        opacity: 1;
    }
    
    .mobile-nav-menu {
        position: fixed;
        top: 0;
        right: -280px;
        width: 280px;
        height: 100%;
        background: white;
        z-index: 999;
        transition: right 0.3s ease;
        box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1);
        overflow-y: auto;
    }
    
    .mobile-nav-menu.active {
        right: 0;
    }
    
    .mobile-nav-header {
        background: linear-gradient(135deg, #4a90e2, #357ab8);
        color: white;
        padding: 1rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    
    .mobile-nav-close {
        background: none;
        border: none;
        color: white;
        font-size: 1.5rem;
        cursor: pointer;
        padding: 0.5rem;
    }
    
    .mobile-nav-items {
        list-style: none;
        padding: 0;
        margin: 0;
    }
    
    .mobile-nav-items li {
        border-bottom: 1px solid #f0f0f0;
    }
    
    .mobile-nav-items a {
        display: flex;
        align-items: center;
        padding: 1rem;
        color: #333;
        text-decoration: none;
        font-weight: 500;
        transition: background-color 0.2s;
    }
    
    .mobile-nav-items a:hover,
    .mobile-nav-items a.active {
        background-color: #f8f9fa;
        color: #2563eb;
    }
    
    .mobile-nav-items a i {
        margin-right: 0.75rem;
        width: 20px;
        text-align: center;
    }
    
    .mobile-nav-items .logout-item {
        border-top: 2px solid #e5e7eb;
        margin-top: 1rem;
    }
    
    .mobile-nav-items .logout-item a {
        color: #dc2626;
    }
    
    @media (max-width: 768px) {
        .mobile-nav-toggle {
            display: block;
        }
        
        .student-nav {
            display: none;
        }
        
        .student-header .container {
            justify-content: space-between;
        }
        
        .student-title {
            font-size: 1.2rem !important;
        }
        
        .student-header img {
            height: 50px !important;
            width: auto !important;
        }
    }
    
    @media (max-width: 480px) {
        .student-title {
            font-size: 1rem !important;
        }
        
        .student-header img {
            height: 40px !important;
        }
        
        .mobile-nav-menu {
            width: 100%;
            right: -100%;
        }
    }
    </style>
</head>
<body {% if request.endpoint == 'student_login' %}class="no-scroll-page login-page"{% elif request.endpoint in ['student_dashboard', 'student_assignments'] %}class="no-scroll-page"{% endif %}>
    <!-- Remove Mobile Navigation Overlay and Menu -->
    <!-- Header Start -->
    <header class="student-header">
        <div class="container" style="display: flex; align-items: center; justify-content: space-between; position: relative;">
            <div style="display: flex; align-items: center; gap: 1.5em;">
                <img src="{{ url_for('static', filename='css/pcshs_logo.png') }}" alt="PCSHS Logo" style="height: 64px; width: auto; margin-right: 18px;">
                <span class="student-title" style="font-size: 2rem; font-weight: 800; color: #fff; margin-right: 2em; letter-spacing: -0.5px;">Student Portal</span>
            </div>
            <!-- Mobile Menu Button -->
            {% if session.student_id %}
            <button id="mobileMenuBtn" class="mobile-menu-btn" style="display:none;">Menu</button>
            {% endif %}
            <!-- Desktop Nav -->
            <nav class="student-nav">
                <ul>
                    {% if session.student_id and request.endpoint != 'student_login' %}
                        <li><a href="{{ url_for('student_dashboard') }}" class="{% if request.endpoint == 'student_dashboard' %}active{% endif %}">Dashboard</a></li>
                        <li><a href="{{ url_for('student_grades') }}" class="{% if request.endpoint == 'student_grades' %}active{% endif %}">Grades</a></li>
                        <li><a href="{{ url_for('student_attendance') }}" class="{% if request.endpoint == 'student_attendance' %}active{% endif %}">Attendance</a></li>
                        <li><a href="{{ url_for('student_quiz') }}" class="{% if request.endpoint == 'student_quiz' %}active{% endif %}">Quiz</a></li>
                        <li><a href="{{ url_for('student_profile') }}" class="{% if request.endpoint == 'student_profile' %}active{% endif %}">Profile</a></li>
                        <li><a href="{{ url_for('student_logout') }}" class="btn btn-danger" style="margin-left: 1em;">Logout</a></li>
                    {% endif %}
                </ul>
            </nav>
            <!-- Mobile Dropdown Nav -->
            <div id="mobileNavDropdown" class="mobile-nav-dropdown" style="display:none; position:absolute; top:100%; right:0; background:#fff; box-shadow:0 4px 16px rgba(0,0,0,0.12); border-radius:10px; min-width:160px; z-index:9999;">
                <ul style="list-style:none; margin:0; padding:0;">
                    {% if session.student_id %}
                        <li><a href="{{ url_for('student_dashboard') }}">Dashboard</a></li>
                        <li><a href="{{ url_for('student_grades') }}">Grades</a></li>
                        <li><a href="{{ url_for('student_attendance') }}">Attendance</a></li>
                        <li><a href="{{ url_for('student_quiz') }}">Quiz</a></li>
                        <li><a href="{{ url_for('student_profile') }}">Profile</a></li>
                        <li><a href="{{ url_for('student_logout') }}" class="btn btn-danger" style="margin:0.5em 0;">Logout</a></li>
                    {% else %}
                        <li><a href="{{ url_for('student_login') }}">Login</a></li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </header>
    <!-- Header End -->
    
    <main class="student-main{% if request.endpoint in ['student_assignments', 'student_assignments_upcoming', 'student_assignments_completed', 'student_assignments_past_due'] %} assignments-main{% endif %}">
        <div class="container">
            <div class="flash-messages" style="position: fixed; top: 130px; left: 50%; transform: translateX(-50%); z-index: 9999; width: auto; max-width: 90vw; pointer-events: none;">
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        {% for category, message in messages %}
                            <div class="alert alert-{{ category }}" style="pointer-events: auto; min-width: 250px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                                <i class="fas fa-info-circle"></i>
                                {{ message }}
                            </div>
                        {% endfor %}
                    {% endif %}
                {% endwith %}
            </div>
            {% block content %}{% endblock %}
        </div>
    </main>
    
    <footer class="student-footer">
        <p>&copy; 2024 Student Monitor - Student Portal. All rights reserved.</p>
    </footer>
    
    <script>
    // Mobile Navigation Toggle
    document.addEventListener('DOMContentLoaded', function() {
        const mobileNavToggle = document.getElementById('mobileNavToggle');
        const mobileNavClose = document.getElementById('mobileNavClose');
        const mobileNavMenu = document.getElementById('mobileNavMenu');
        const mobileNavOverlay = document.getElementById('mobileNavOverlay');
        
        function openMobileNav() {
            mobileNavMenu.classList.add('active');
            mobileNavOverlay.classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        
        function closeMobileNav() {
            mobileNavMenu.classList.remove('active');
            mobileNavOverlay.classList.remove('active');
            document.body.style.overflow = '';
        }
        
        mobileNavToggle.addEventListener('click', openMobileNav);
        mobileNavClose.addEventListener('click', closeMobileNav);
        mobileNavOverlay.addEventListener('click', closeMobileNav);
        
        // Close mobile nav when clicking on a link (always reload, even if same page)
        const mobileNavLinks = mobileNavMenu.querySelectorAll('a');
        mobileNavLinks.forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                // Close the menu and overlay
                if (mobileNavMenu && mobileNavOverlay) {
                    mobileNavMenu.classList.remove('active');
                    mobileNavOverlay.classList.remove('active');
                    document.body.style.overflow = '';
                }
                // Always reload, even if same page
                setTimeout(function() {
                    window.location.href = link.href;
                }, 10);
            });
        });
        
        // Close mobile nav on escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && mobileNavMenu.classList.contains('active')) {
                closeMobileNav();
            }
        });
    });
    
    // Force full page reload on ALL header, desktop nav, and mobile nav links
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('header a, .student-nav a, .mobile-nav-menu a').forEach(function(link) {
            link.addEventListener('click', function(e) {
                // Only handle left-clicks and no modifier keys
                if (e.button === 0 && !e.ctrlKey && !e.metaKey && !e.shiftKey && !e.altKey) {
                    e.preventDefault();
                    window.location.href = link.href;
                }
            });
        });
    });
    
    // Auto-fade flash messages after 3 seconds
    window.addEventListener('DOMContentLoaded', function() {
        setTimeout(function() {
            document.querySelectorAll('.flash-messages .alert').forEach(function(el) {
                el.style.transition = 'opacity 0.5s';
                el.style.opacity = '0';
                setTimeout(function() { el.remove(); }, 500);
            });
        }, 3000);
    });
    
    // Prevent zoom on double tap (iOS)
    let lastTouchEnd = 0;
    document.addEventListener('touchend', function (event) {
        const now = (new Date()).getTime();
        if (now - lastTouchEnd <= 300) {
            event.preventDefault();
        }
        lastTouchEnd = now;
    }, false);
    
    // Mobile menu dropdown toggle
    document.addEventListener('DOMContentLoaded', function() {
        var btn = document.getElementById('mobileMenuBtn');
        var dropdown = document.getElementById('mobileNavDropdown');
        btn && btn.addEventListener('click', function(e) {
            e.stopPropagation();
            dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
        });
        // Hide dropdown when clicking outside
        document.addEventListener('click', function(e) {
            if (dropdown && dropdown.style.display === 'block' && !dropdown.contains(e.target) && e.target !== btn) {
                dropdown.style.display = 'none';
            }
        });
    });
    </script>
    <script>
    // --- Student Portal: Log out on tab close (sessionStorage approach) ---
    (function() {
        const SESSION_KEY = 'student_portal_active';
        // If the flag is missing, log out and redirect
        if (!sessionStorage.getItem(SESSION_KEY)) {
            fetch("{{ url_for('student_logout') }}", {method: 'POST'}).then(() => {
                window.location.href = "{{ url_for('student_login') }}";
            });
        } else {
            // If the flag exists, do nothing (user is active in this tab)
        }
        // Set the flag for this tab
        sessionStorage.setItem(SESSION_KEY, '1');
        // On tab close, log out
        window.addEventListener('unload', function() {
            navigator.sendBeacon("{{ url_for('student_logout') }}");
        });
    })();
    </script>
</body>
</html>
