{% extends 'parent_base.html' %}

{% block title %}Attendance - Parent Portal{% endblock %}

{% block content %}
<style>
    .attendance-status-cell {
        font-weight: bold;
        color: #fff;
        border-radius: 6px;
        padding: 0.4em 0.8em;
        display: inline-block;
        min-width: 90px;
        text-align: center;
    }
    .status-present { background: #28a745; }
    .status-absent { background: #dc3545; }
    .status-late { background: #ffc107; color: #333; }
    .status-excused { background: #17a2b8; }
    .status-notrecorded { background: #6c757d; }
    .attendance-table-scrollable {
        max-height: 350px;
        overflow-y: auto;
        border-radius: 8px;
        border: 1px solid #e0e0e0;
        background: #fff;
    }
    .attendance-table-scrollable table {
        min-width: 600px;
    }
    .attendance-filter-row {
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 1rem;
    }
    .attendance-dropdown {
        padding: 0.45em 1.2em;
        border-radius: 6px;
        border: 1px solid #bfc9d1;
        background: #f8fafc;
        font-size: 1em;
        font-weight: 500;
        color: #222;
        transition: border 0.2s;
        box-shadow: 0 1px 4px rgba(0,0,0,0.04);
        cursor: pointer;
    }
    .attendance-dropdown:focus {
        border: 1.5px solid #2563eb;
        outline: none;
    }
    @media (max-width: 600px) {
        .attendance-filter-row {
            flex-direction: column;
            align-items: stretch;
            gap: 0.5rem;
        }
        .attendance-dropdown {
            width: 100% !important;
            min-width: 0;
            font-size: 1.08em;
            padding: 0.7em 1em;
        }
        .attendance-filter-row label {
            margin-bottom: 0.2em;
        }
    }
    .attendance-note {
        display: block;
        font-size: 0.92em;
        color: #4b5563;
        margin-top: 2px;
        font-style: italic;
        word-break: break-word;
        max-width: 140px;
        white-space: pre-line;
    }
    .attendance-clear-btn {
        background: #f8fafc;
        border: 1px solid #bfc9d1;
        color: #222;
        padding: 0.45em 1.2em;
        border-radius: 6px;
        font-size: 1em;
        font-weight: 500;
        box-shadow: 0 1px 4px rgba(0,0,0,0.04);
        cursor: pointer;
        transition: background 0.2s, border 0.2s;
        margin-left: 0.2em;
    }
    .attendance-clear-btn:hover {
        background: #e5e7eb;
        border: 1.5px solid #2563eb;
    }
</style>
<div class="dashboard-header">
    <h2>Attendance for {{ student.name }}</h2>
    <p>Below is the attendance record for this student, grouped by date and subject.</p>
</div>

<div class="attendance-filter-row">
    <label for="attendanceStatusFilter"><strong>Filter by Status:</strong></label>
    <select id="attendanceStatusFilter" class="form-select attendance-dropdown" style="width: 180px;">
        <option value="all">All</option>
        <option value="present">Present</option>
        <option value="absent">Absent</option>
        <option value="late">Late</option>
        <option value="excused">Excused</option>
        <option value="notrecorded">Not Recorded</option>
    </select>
    <label for="attendanceSubjectFilter"><strong>Subject:</strong></label>
    <select id="attendanceSubjectFilter" class="form-select attendance-dropdown" style="width: 180px;">
        <option value="all">All Subjects</option>
        {% for subject in subject_names %}
        <option value="{{ loop.index }}">{{ subject }}</option>
        {% endfor %}
    </select>
    <button type="button" class="attendance-clear-btn" id="attendanceClearBtn">Clear</button>
</div>

{% if attendance_by_date %}
    <div class="card mb-4">
        <div class="card-body attendance-table-scrollable">
            <table class="table table-striped" id="attendanceTable">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Subject</th>
                        <th>Status</th>
                        <th>Notes</th>
                    </tr>
                </thead>
                <tbody>
                    {% for date, subj_statuses in attendance_by_date.items() %}
                        {% for subject in subject_names %}
                            {% set cell = subj_statuses.get(subject, {'status': 'Not Recorded', 'notes': None}) %}
                            {% set status = cell.status if cell.status is defined else cell['status'] %}
                            {% set notes = cell.notes if cell.notes is defined else cell['notes'] %}
                            <tr>
                                <td>{{ date.strftime('%Y-%m-%d') }}</td>
                                <td>{{ subject }}</td>
                                <td>
                                    {% if status == 'present' %}
                                        <span class="attendance-status-cell status-present" data-status="present">Present</span>
                                    {% elif status == 'absent' %}
                                        <span class="attendance-status-cell status-absent" data-status="absent">Absent</span>
                                    {% elif status == 'late' %}
                                        <span class="attendance-status-cell status-late" data-status="late">Late</span>
                                    {% elif status == 'excused' %}
                                        <span class="attendance-status-cell status-excused" data-status="excused">Excused</span>
                                    {% else %}
                                        <span class="attendance-status-cell status-notrecorded" data-status="notrecorded">Not Recorded</span>
                                    {% endif %}
                                </td>
                                <td>{% if notes %}<span class="attendance-note">{{ notes }}</span>{% else %}--{% endif %}</td>
                            </tr>
                        {% endfor %}
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    <script>
    function filterAttendanceTable() {
        const statusFilter = document.getElementById('attendanceStatusFilter').value;
        const subjectFilter = document.getElementById('attendanceSubjectFilter').value;
        const table = document.getElementById('attendanceTable');
        const rows = table.querySelectorAll('tbody tr');
        // Get subject names for mapping index to name
        const subjectOptions = Array.from(document.getElementById('attendanceSubjectFilter').options).map(opt => opt.text);
        let selectedSubject = null;
        if (subjectFilter !== 'all') {
            selectedSubject = subjectOptions[parseInt(subjectFilter)];
        }
        rows.forEach(row => {
            const subjectCell = row.children[1]; // 2nd column is Subject
            const statusCell = row.children[2]; // 3rd column is Status
            let showRow = true;
            // Subject filter
            if (selectedSubject && subjectCell.textContent.trim() !== selectedSubject) {
                showRow = false;
            }
            // Status filter
            if (showRow && statusFilter !== 'all') {
                const statusSpan = statusCell.querySelector('.attendance-status-cell');
                if (!statusSpan || statusSpan.getAttribute('data-status') !== statusFilter) {
                    showRow = false;
                }
            }
            row.style.display = showRow ? '' : 'none';
        });
    }
    document.getElementById('attendanceStatusFilter').addEventListener('change', filterAttendanceTable);
    document.getElementById('attendanceSubjectFilter').addEventListener('change', filterAttendanceTable);
    document.getElementById('attendanceClearBtn').addEventListener('click', function() {
        document.getElementById('attendanceStatusFilter').value = 'all';
        document.getElementById('attendanceSubjectFilter').value = 'all';
        filterAttendanceTable();
    });
    // Run once on page load to apply default filters
    filterAttendanceTable();
    </script>
{% else %}
    <div class="empty-state">
        <h3>No Attendance Records Found</h3>
        <p>This student does not have any attendance records yet.</p>
    </div>
{% endif %}
{% endblock %} 