{% extends 'base.html' %}

{% block title %}Edit Student - Student Monitor{% endblock %}

{% block content %}
<div class="form-page-container">
    <h2>Edit Student: {{ student.name }}</h2>
    <form method="POST" class="app-form">
        <div class="form-group">
            <label for="name">Student Full Name:</label>
            <input type="text" id="name" name="name" value="{{ student.name }}" required>
        </div>
        <div class="form-group">
            <label for="student_id_number">Student ID Number:</label>
            <input type="text" id="student_id_number" name="student_id_number" value="{{ student.student_id_number }}" required>
        </div>
        <div class="form-group">
            <label for="password">Student Password:</label>
            <input type="password" id="password" name="password" value="{{ request.form.get('password', student.password_hash or '') }}">
            <button type="button" class="password-toggle" onclick="togglePassword('password')" style="display: none;">Show</button>
            <input type="hidden" id="password_stored" value="{{ request.form.get('password', student.password_hash or '') }}">
        </div>
        <div class="form-group">
            <label for="gender">Gender:</label>
            <select id="gender" name="gender" required>
                <option value="">Select Gender</option>
                <option value="Male" {% if student.gender == 'Male' %}selected{% endif %}>Boy</option>
                <option value="Female" {% if student.gender == 'Female' %}selected{% endif %}>Girl</option>
            </select>
        </div>
        {# Updated dropdown to select SectionPeriod #}
        <div class="form-group">
            <label for="section_period_id">Assign to Section & {{ student.section_period.period_type }}:</label>
            <select id="section_period_id" name="section_period_id" required>
                <option value="">-- Select Section & Period --</option>
                {% for sp in section_periods %}
                    <option value="{{ sp.id }}" {% if student.section_period_id == sp.id %}selected{% endif %}>
                        {{ sp.section.name }} ({{ sp.period_name }} {{ sp.school_year }}) - {{ sp.section.grade_level.name }}
                        {% if sp.strand %}({{ sp.strand.name }}){% endif %}
                    </option>
                {% endfor %}
            </select>
        </div>
        <div class="button-group-right">
            <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Save Changes</button>
            <a href="{{ url_for('section_period_details', section_period_id=student.section_period_id) }}" class="btn btn-secondary"><i class="fas fa-times-circle"></i> Cancel</a>
        </div>
    </form>
</div>
{% endblock %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    const passwordField = document.getElementById('password');
    const toggleButton = document.querySelector('.password-toggle');
    const storedPassword = document.getElementById('password_stored');
    
    // Restore password from localStorage if available
    const savedPassword = localStorage.getItem('editStudentPassword');
    if (savedPassword && !passwordField.value) {
        passwordField.value = savedPassword;
        storedPassword.value = savedPassword;
    }
    
    // Show toggle button when password field has content
    function updateToggleVisibility() {
        if (passwordField.value.length > 0) {
            toggleButton.style.display = 'inline-block';
            // Save to localStorage
            localStorage.setItem('editStudentPassword', passwordField.value);
        } else {
            toggleButton.style.display = 'none';
            // Clear from localStorage
            localStorage.removeItem('editStudentPassword');
        }
    }
    
    // Initial check - show toggle if there's a password hash
    updateToggleVisibility();
    
    // Check on input
    passwordField.addEventListener('input', updateToggleVisibility);
    
    // Save password when form is submitted
    const form = document.querySelector('form');
    form.addEventListener('submit', function() {
        localStorage.setItem('editStudentPassword', passwordField.value);
    });
});

function togglePassword(fieldId) {
    const field = document.getElementById(fieldId);
    const toggleButton = event.target;
    
    if (field.type === 'password') {
        field.type = 'text';
        toggleButton.textContent = 'Hide';
    } else {
        field.type = 'password';
        toggleButton.textContent = 'Show';
    }
}
</script>
