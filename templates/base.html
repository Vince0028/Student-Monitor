<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#4a5568">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>{% block title %}Student Monitor{% endblock %}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/student_style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    {# Bootstrap CSS CDN for the modal #}
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
    <!-- jQuery (for pages that use $) -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body data-user-type="{{ session.user_type }}"{% if login_page %} class="no-scroll-page login-page"{% endif %}>
    <header class="app-header" style="background: #4a5568; min-height: 64px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
        <div class="container app-header-flex" style="display: flex; align-items: center; justify-content: space-between; max-width: 1200px; margin: 0 auto; width: 100%; height: 64px; min-height: 64px; padding: 0 2.2em;">
            <div class="header-left" style="display: flex; align-items: center; gap: 1.2em; min-width: 0; height: 100%;">
                <img src="{{ url_for('static', filename='css/pcshs_logo.png') }}" alt="PCSHS Logo" style="height: 48px; width: auto; margin-right: 10px;">
                <h1 class="app-title" style="margin: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: #fff; font-weight: 700; font-size: 2rem;"> <a href="{{ url_for('dashboard') if session.user_id else url_for('index') }}" style="color: #fff; text-decoration: none;">Student Monitor</a></h1>
            </div>
            <div class="header-right" style="display: flex; align-items: center; gap: 0.7em; height: 100%;">
                <!-- Hamburger button for mobile (always right-aligned) -->
                <button id="hamburgerBtn" class="hamburger" aria-label="Open menu" aria-controls="mobileNav" aria-expanded="false" style="margin: 0; padding: 0; background: none;">
                    <span></span><span></span><span></span>
                </button>
            </div>
            <nav class="main-nav">
                <ul class="nav-links">
                    {% if session.user_id %} {# Check if user is logged in #}
                        <li><a href="{{ url_for('profile') }}"><i class="fas fa-user-circle"></i> <span class="nav-text">Profile</span></a></li>
                        {% if session.user_type == 'admin' %}
                            <li><a href="{{ url_for('admin_dashboard') }}"><i class="fas fa-tachometer-alt"></i> <span class="nav-text">Dashboard</span></a></li>
                        {% elif session.user_type == 'teacher' %}
                            <li><a href="{{ url_for('teacher_dashboard') }}"><i class="fas fa-chalkboard-teacher"></i> <span class="nav-text">Dashboard</span></a></li>
                        {% endif %}
                        <li><a href="{{ url_for('logout') }}" class="btn-logout"><i class="fas fa-sign-out-alt"></i> <span class="nav-text">Logout</span></a></li>
                        <li>
                            <button id="darkModeToggle" class="btn btn-outline-secondary d-none d-md-inline-flex" title="Toggle dark mode" style="margin-left: 0.5em; align-items: center; gap: 0.4em;">
                                <i id="darkModeIcon" class="fas fa-moon"></i>
                                <span id="darkModeText" style="font-size: 1em;">Dark Mode</span>
                            </button>
                        </li>
                    {% else %}
                        <li><a href="{{ url_for('login') }}"><i class="fas fa-sign-in-alt"></i> <span class="nav-text">Login</span></a></li>
                        <li><a href="{{ url_for('register') }}"><i class="fas fa-user-plus"></i> <span class="nav-text">Register</span></a></li>
                    {% endif %}
                </ul>
            </nav>
        </div>
    </header>

    <!-- Off-canvas mobile nav -->
    <nav id="mobileNav" class="mobile-nav" aria-hidden="true">
        <div class="mobile-nav-header">
            <span>Menu</span>
            <button id="closeMobileNav" aria-label="Close menu">&times;</button>
        </div>
        <ul>
            {% if session.user_id %}
                <li><a href="{{ url_for('profile') }}"><i class="fas fa-user-circle"></i> Profile</a></li>
                {% if session.user_type == 'admin' %}
                    <li><a href="{{ url_for('admin_dashboard') }}"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
                {% elif session.user_type == 'teacher' %}
                    <li><a href="{{ url_for('teacher_dashboard') }}"><i class="fas fa-chalkboard-teacher"></i> Dashboard</a></li>
                {% endif %}
                <li><a href="{{ url_for('logout') }}"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
            {% else %}
                <li><a href="{{ url_for('login') }}"><i class="fas fa-sign-in-alt"></i> Login</a></li>
                <li><a href="{{ url_for('register') }}"><i class="fas fa-user-plus"></i> Register</a></li>
            {% endif %}
        </ul>
        <div style="padding: 1.2em 1.5em 1.5em 1.5em; border-top: 1px solid #e2e8f0;">
            <button id="mobileDarkModeToggle" class="btn btn-outline-secondary w-100" style="display: flex; align-items: center; gap: 0.7em; justify-content: flex-start;">
                <i id="mobileDarkModeIcon" class="fas fa-moon"></i>
                <span id="mobileDarkModeText">Dark Mode</span>
            </button>
        </div>
    </nav>
    <div id="mobileNavOverlay" class="mobile-nav-overlay"></div>

    <main class="app-main container">
        {% if not login_page %}
        <div class="flash-messages">
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }}" role="alert">{{ message }}</div>
                    {% endfor %}
                {% endif %}
            {% endwith %}
        </div>
        {% endif %}
        {% block content %}{% endblock %}
    </main>

    {% include 'profile_password_modal.html' %}

    <footer class="app-footer">
        <div class="container">
            <p>&copy; 2025 Student Monitor. All rights reserved.</p>
        </div>
    </footer>

    {# Bootstrap JS Bundle with Popper #}
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" xintegrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    <script>
        // Function to show the universal confirmation modal
        function showUniversalConfirmationModal(actionUrl, successRedirectUrl, message, confirmText = 'Confirm') {
            const modalElement = document.getElementById('confirmDeleteModal');
            const modal = new bootstrap.Modal(modalElement);
            const modalTitle = document.getElementById('confirmDeleteModalLabel');
            const modalActionMessage = document.getElementById('modalActionMessage');
            const modalPasswordInput = document.getElementById('modalPassword');
            const confirmActionButton = document.getElementById('confirmActionButton');
            const modalFeedback = document.getElementById('modalFeedback');

            // Set modal title and message
            modalTitle.textContent = 'Confirm Action'; // Generic title
            modalActionMessage.textContent = message;
            confirmActionButton.textContent = confirmText; // Change button text
            confirmActionButton.className = confirmActionButton.className.replace(/btn-(danger|primary)/, `btn-${confirmText === 'Delete' ? 'danger' : 'primary'}`); // Dynamically set button color

            // Clear previous state
            modalPasswordInput.value = '';
            modalFeedback.textContent = ''; // Clear any previous feedback

            // Clone the button to remove all previous event listeners
            const newConfirmActionButton = confirmActionButton.cloneNode(true);
            confirmActionButton.parentNode.replaceChild(newConfirmActionButton, confirmActionButton);

            newConfirmActionButton.onclick = async function() {
                const password = modalPasswordInput.value;
                if (!password) {
                    modalFeedback.textContent = 'Password is required.';
                    return;
                }

                // Disable button and show loading
                newConfirmActionButton.disabled = true;
                newConfirmActionButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Processing...';

                try {
                    const response = await fetch(actionUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: new URLSearchParams({
                            'password': password
                        })
                    });

                    const data = await response.json(); // Expecting JSON response

                    if (data.success) {
                        modal.hide(); // Hide the modal first
                        // Add a small delay for the modal to fully close before redirecting
                        setTimeout(() => {
                            // Use window.location.replace to prevent going back after action
                            window.location.replace(data.redirect_url || successRedirectUrl || window.location.href); 
                        }, 300); 
                    } else {
                        modalFeedback.textContent = data.message || 'Action failed. Please try again.';
                        modalPasswordInput.value = ''; // Clear password on failure
                    }
                } catch (error) {
                    console.error('Error during action:', error);
                    modalFeedback.textContent = 'An error occurred. Please try again.';
                } finally {
                    // Re-enable button
                    newConfirmActionButton.disabled = false;
                    newConfirmActionButton.innerHTML = confirmText; // Reset button text
                }
            };

            modal.show();
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Mobile-specific enhancements
            const isMobile = window.innerWidth <= 768;
            
            // Add touch-friendly interactions for mobile
            if (isMobile) {
                // Increase touch targets
                document.querySelectorAll('.btn, .nav-links a').forEach(element => {
                    element.style.minHeight = '44px';
                    element.style.minWidth = '44px';
                });
                
                // Add swipe gestures for tables (if needed)
                const tables = document.querySelectorAll('.table-responsive');
                tables.forEach(table => {
                    let startX = 0;
                    let scrollLeft = 0;
                    
                    table.addEventListener('touchstart', (e) => {
                        startX = e.touches[0].pageX - table.offsetLeft;
                        scrollLeft = table.scrollLeft;
                    });
                    
                    table.addEventListener('touchmove', (e) => {
                        if (!startX) return;
                        const x = e.touches[0].pageX - table.offsetLeft;
                        const walk = (x - startX) * 2;
                        table.scrollLeft = scrollLeft - walk;
                    });
                    
                    table.addEventListener('touchend', () => {
                        startX = 0;
                    });
                });
            }

            const profileLink = document.querySelector('.nav-links a[href*="profile"]');
            if (profileLink && document.body.dataset.userType === "teacher") {
                profileLink.addEventListener('click', function(event) {
                    event.preventDefault();
                    const passwordModal = new bootstrap.Modal(document.getElementById('passwordConfirmModal'));
                    passwordModal.show();
                });
            }

            // Event listener for all delete buttons using 'delete-btn' class
            document.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', function(event) {
                    event.preventDefault(); // Prevent default form submission
                    const deleteUrl = event.currentTarget.dataset.deleteUrl;
                    const redirectUrl = event.currentTarget.dataset.redirectUrl;
                    const confirmationMessage = event.currentTarget.dataset.confirmationMessage || 'Are you sure you want to delete this item? This action cannot be undone.';
                    const itemName = event.currentTarget.dataset.itemName; 
                    
                    showUniversalConfirmationModal(
                        deleteUrl, 
                        redirectUrl, 
                        `${confirmationMessage}`, // Message from data attribute
                        'Delete' // Button text
                    );
                });
            });

            // Event listener for "Assign Teachers to Unassigned Periods" button
            const reassignTeachersBtn = document.getElementById('reassignTeachersBtn');
            if (reassignTeachersBtn) {
                reassignTeachersBtn.addEventListener('click', function() {
                    // TODO: Implement reassign_period_teachers route
                    alert('This feature is not yet implemented.');
                    const redirectUrl = '{{ url_for("admin_dashboard") }}'; // Updated to use admin_dashboard
                    const message = 'This action will attempt to assign registered teacher accounts to periods that are currently unassigned based on their grade level and specialization.';
                    // showUniversalConfirmationModal(
                    //     reassignUrl, 
                    //     redirectUrl, 
                    //     message, 
                    //     'Reassign' // Button text
                    // );
                });
            }

            // Auto-hide flash messages after 5 seconds on mobile
            if (isMobile) {
                setTimeout(() => {
                    const flashMessages = document.querySelectorAll('.alert');
                    flashMessages.forEach(message => {
                        message.style.transition = 'opacity 0.5s ease';
                        message.style.opacity = '0';
                        setTimeout(() => message.remove(), 500);
                    });
                }, 5000);
            }

            // Prevent zoom on input focus for iOS
            const inputs = document.querySelectorAll('input[type="text"], input[type="password"], input[type="email"], input[type="number"], input[type="date"], select, textarea');
            inputs.forEach(input => {
                input.addEventListener('focus', function() {
                    if (isMobile) {
                        this.style.fontSize = '16px';
                    }
                });
                
                input.addEventListener('blur', function() {
                    if (isMobile) {
                        this.style.fontSize = '';
                    }
                });
            });
        });

        function submitPassword() {
            const password = document.getElementById('adminPassword').value;
            const errorDiv = document.getElementById('passwordError');
            
            fetch("{{ url_for('verify_password_for_profile') }}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ password: password })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    setTimeout(function() {
                        window.location.href = "{{ url_for('profile') }}";
                    }, 300); // 300ms delay to allow session cookie to be set
                } else {
                    errorDiv.textContent = data.message || 'Incorrect password.';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                errorDiv.textContent = 'An error occurred. Please try again.';
            });
        }

        // Add responsive table functionality
        function makeTablesResponsive() {
            const tables = document.querySelectorAll('.data-table');
            tables.forEach(table => {
                const headers = table.querySelectorAll('th');
                const cells = table.querySelectorAll('td');
                
                headers.forEach((header, index) => {
                    const headerText = header.textContent.trim();
                    cells.forEach((cell, cellIndex) => {
                        if (cellIndex % headers.length === index) {
                            cell.setAttribute('data-label', headerText);
                        }
                    });
                });
            });
        }

        // Call on page load and window resize
        document.addEventListener('DOMContentLoaded', makeTablesResponsive);
        window.addEventListener('resize', makeTablesResponsive);

        // Fade out flash messages after 3 seconds
        setTimeout(function() {
            document.querySelectorAll('.flash-messages .alert').forEach(function(el) {
                el.style.transition = 'opacity 0.7s';
                el.style.opacity = '0';
                setTimeout(function() { el.style.display = 'none'; }, 700);
            });
        }, 3000);
    </script>
    {% block scripts %}{% endblock %}
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Password Toggle Functionality -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Function to create password toggle button
            function createPasswordToggle(passwordInput) {
                if (passwordInput.parentElement.classList.contains('password-field-container')) {
                    return;
                }
                const container = document.createElement('div');
                container.className = 'password-field-container';
                passwordInput.parentNode.insertBefore(container, passwordInput);
                container.appendChild(passwordInput);
                const toggleBtn = document.createElement('button');
                toggleBtn.type = 'button';
                toggleBtn.className = 'password-toggle-btn';
                toggleBtn.textContent = passwordInput.type === 'password' ? 'Show' : 'Hide';
                toggleBtn.setAttribute('aria-label', 'Toggle password visibility');
                toggleBtn.style.display = passwordInput.value ? '' : 'none';
                container.appendChild(toggleBtn);
                toggleBtn.addEventListener('click', function() {
                    const isPassword = passwordInput.type === 'password';
                    passwordInput.type = isPassword ? 'text' : 'password';
                    toggleBtn.textContent = isPassword ? 'Hide' : 'Show';
                    toggleBtn.classList.toggle('show', isPassword);
                });
                passwordInput.addEventListener('input', function() {
                    toggleBtn.style.display = passwordInput.value ? '' : 'none';
                });
            }
            const passwordInputs = document.querySelectorAll('input[type="password"], input[type="text"]');
            passwordInputs.forEach(function(input) {
                if (input.type === 'password' || (input.type === 'text' && input.name && input.name.toLowerCase().includes('password'))) {
                    createPasswordToggle(input);
                }
            });
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    mutation.addedNodes.forEach(function(node) {
                        if (node.nodeType === 1) {
                            const newPasswordInputs = node.querySelectorAll ? node.querySelectorAll('input[type="password"], input[type="text"]') : [];
                            newPasswordInputs.forEach(function(input) {
                                if (input.type === 'password' || (input.type === 'text' && input.name && input.name.toLowerCase().includes('password'))) {
                                    createPasswordToggle(input);
                                }
                            });
                        }
                    });
                });
            });
            observer.observe(document.body, { childList: true, subtree: true });
        });
    </script>
    <!-- Dark mode toggle logic -->
    <script>
        function setDarkMode(enabled) {
            if (enabled) {
                document.body.classList.add('dark-mode');
                document.getElementById('darkModeIcon').classList.remove('fa-moon');
                document.getElementById('darkModeIcon').classList.add('fa-sun');
                document.getElementById('darkModeText').textContent = 'Light Mode';
                // Mobile
                document.getElementById('mobileDarkModeIcon').classList.remove('fa-moon');
                document.getElementById('mobileDarkModeIcon').classList.add('fa-sun');
                document.getElementById('mobileDarkModeText').textContent = 'Light Mode';
            } else {
                document.body.classList.remove('dark-mode');
                document.getElementById('darkModeIcon').classList.remove('fa-sun');
                document.getElementById('darkModeIcon').classList.add('fa-moon');
                document.getElementById('darkModeText').textContent = 'Dark Mode';
                // Mobile
                document.getElementById('mobileDarkModeIcon').classList.remove('fa-sun');
                document.getElementById('mobileDarkModeIcon').classList.add('fa-moon');
                document.getElementById('mobileDarkModeText').textContent = 'Dark Mode';
            }
        }
        document.addEventListener('DOMContentLoaded', function() {
            const darkMode = localStorage.getItem('darkMode') === 'true';
            setDarkMode(darkMode);
            const toggleBtn = document.getElementById('darkModeToggle');
            const mobileToggleBtn = document.getElementById('mobileDarkModeToggle');
            function toggleDark() {
                const enabled = !document.body.classList.contains('dark-mode');
                setDarkMode(enabled);
                localStorage.setItem('darkMode', enabled);
            }
            if (toggleBtn) toggleBtn.addEventListener('click', toggleDark);
            if (mobileToggleBtn) mobileToggleBtn.addEventListener('click', toggleDark);
        });
    </script>

    <style>
    /* Header flex fix and ensure hamburger is inside header bar */
    .app-header {
      background: #4a5568;
      min-height: 64px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
      width: 100%;
    }
    .app-header-flex {
      display: flex;
      align-items: center;
      justify-content: space-between;
      max-width: 1200px;
      margin: 0 auto;
      width: 100%;
      height: 64px;
      min-height: 64px;
      padding: 0 2.2em;
    }
    .header-left { display: flex; align-items: center; gap: 1.2em; min-width: 0; height: 100%; }
    .header-right { display: flex; align-items: center; gap: 0.7em; height: 100%; }
    .app-title { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: #fff; font-weight: 700; font-size: 2rem; }
    .app-title a { color: #fff; text-decoration: none; }
    .hamburger {
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      width: 44px;
      height: 44px;
      background: none;
      border: none;
      cursor: pointer;
      z-index: 1201;
      margin: 0;
      padding: 0;
      border-radius: 8px;
      transition: background 0.18s, box-shadow 0.18s, transform 0.18s;
    }
    .hamburger:hover,
    .hamburger:focus-visible,
    .hamburger:active {
      background: rgba(255,255,255,0.13);
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      outline: none;
      transform: scale(1.07);
    }
    .hamburger:focus-visible {
      outline: 2px solid #3182ce;
      outline-offset: 2px;
    }
    .hamburger span {
      display: block;
      width: 28px;
      height: 3px;
      margin: 4px 0;
      background: #fff;
      border-radius: 2px;
      transition: all 0.3s;
    }
    @media (max-width: 768px) {
      html, body {
        overflow-x: hidden;
        max-width: 100vw;
      }
      .hamburger { display: flex; }
      .main-nav { display: none !important; }
      .header-right { gap: 0.5em; padding-right: 2px; }
      .app-header-flex {
        height: 56px;
        min-height: 56px;
        padding: 0 0.5em !important;
        max-width: 100% !important;
        margin: 0 !important;
      }
      .app-header, .app-header-flex, .container {
        box-sizing: border-box;
        max-width: 100vw !important;
      }
      .app-title { font-size: 1.3rem; }
      .header-left img { height: 38px !important; }
      #hamburgerBtn { margin-right: 0; }
    }
    @media (min-width: 769px) {
      .mobile-nav, .mobile-nav-overlay, #hamburgerBtn { display: none !important; }
    }
    /* Off-canvas mobile nav styles */
    .mobile-nav {
      position: fixed;
      top: 0; left: 0;
      width: 260px;
      height: 100vh;
      background: #fff;
      box-shadow: 2px 0 16px rgba(0,0,0,0.13);
      z-index: 1202;
      transform: translateX(-100%);
      transition: transform 0.3s cubic-bezier(.4,0,.2,1);
      padding-top: 0;
      display: flex;
      flex-direction: column;
    }
    .mobile-nav.open {
      transform: translateX(0);
    }
    .mobile-nav-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1.2em 1.2em 1em 1.2em;
      border-bottom: 1px solid #e2e8f0;
      font-weight: bold;
      font-size: 1.1em;
    }
    .mobile-nav ul {
      list-style: none;
      padding: 0;
      margin: 0;
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 0.5em;
    }
    .mobile-nav ul li {
      border-bottom: 1px solid #f1f1f1;
    }
    .mobile-nav ul li:last-child {
      border-bottom: none;
    }
    .mobile-nav ul li a {
      display: block;
      padding: 1em 1.5em;
      color: #2d3748;
      text-decoration: none;
      font-size: 1.08em;
      transition: background 0.18s, color 0.18s;
      border-radius: 6px;
    }
    .mobile-nav ul li a:hover,
    .mobile-nav ul li a:focus-visible,
    .mobile-nav ul li a:active {
      background: #e2e8f0;
      color: #1a202c;
      outline: none;
    }
    .mobile-nav ul li a:focus-visible {
      outline: 2px solid #3182ce;
      outline-offset: 2px;
    }
    .mobile-nav-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0,0,0,0.18);
      z-index: 1200;
      transition: opacity 0.3s;
    }
    .mobile-nav.open ~ .mobile-nav-overlay {
      display: block;
      opacity: 1;
    }
    </style>

    <script>
    // Hamburger and mobile nav logic
    const hamburgerBtn = document.getElementById('hamburgerBtn');
    const mobileNav = document.getElementById('mobileNav');
    const mobileNavOverlay = document.getElementById('mobileNavOverlay');
    const closeMobileNav = document.getElementById('closeMobileNav');

    function openMobileNav() {
      mobileNav.classList.add('open');
      mobileNav.setAttribute('aria-hidden', 'false');
      hamburgerBtn.setAttribute('aria-expanded', 'true');
      mobileNavOverlay.style.display = 'block';
      setTimeout(() => { mobileNavOverlay.style.opacity = '1'; }, 10);
    }
    function closeMobileNavFunc() {
      mobileNav.classList.remove('open');
      mobileNav.setAttribute('aria-hidden', 'true');
      hamburgerBtn.setAttribute('aria-expanded', 'false');
      mobileNavOverlay.style.opacity = '0';
      setTimeout(() => { mobileNavOverlay.style.display = 'none'; }, 300);
    }
    if (hamburgerBtn && mobileNav && mobileNavOverlay && closeMobileNav) {
      hamburgerBtn.addEventListener('click', openMobileNav);
      closeMobileNav.addEventListener('click', closeMobileNavFunc);
      mobileNavOverlay.addEventListener('click', closeMobileNavFunc);
      // Close on ESC
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && mobileNav.classList.contains('open')) closeMobileNavFunc();
      });
    }
    </script>
</body>
</html>
