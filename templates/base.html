<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#4a5568">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>{% block title %}Student Monitor{% endblock %}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/student_style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    {# Bootstrap CSS CDN for the modal #}
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
    <!-- jQuery (for pages that use $) -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body data-user-type="{{ session.user_type }}"{% if login_page %} class="no-scroll-page login-page"{% endif %}>
    <header class="app-header">
        <div class="container" style="display: flex; align-items: center; justify-content: space-between;">
            <div style="display: flex; align-items: center; gap: 1.2em;">
                <img src="{{ url_for('static', filename='css/pcshs_logo.png') }}" alt="PCSHS Logo" style="height: 48px; width: auto; margin-right: 10px;">
                <h1 class="app-title" style="margin: 0;"><a href="{{ url_for('dashboard') if session.user_id else url_for('index') }}">Student Monitor</a></h1>
            </div>
            <nav class="main-nav">
                <ul class="nav-links">
                    {% if session.user_id %} {# Check if user is logged in #}
                        <li><a href="{{ url_for('profile') }}"><i class="fas fa-user-circle"></i> <span class="nav-text">Profile</span></a></li>
                        {% if session.user_type == 'admin' %}
                            <li><a href="{{ url_for('admin_dashboard') }}"><i class="fas fa-tachometer-alt"></i> <span class="nav-text">Dashboard</span></a></li>
                        {% elif session.user_type == 'teacher' %}
                            <li><a href="{{ url_for('teacher_dashboard') }}"><i class="fas fa-chalkboard-teacher"></i> <span class="nav-text">Dashboard</span></a></li>
                        {% endif %}
                        <li><a href="{{ url_for('logout') }}" class="btn-logout"><i class="fas fa-sign-out-alt"></i> <span class="nav-text">Logout</span></a></li>
                        <li>
                            <button id="darkModeToggle" class="btn btn-outline-secondary" title="Toggle dark mode" style="margin-left: 0.5em;">
                                <i id="darkModeIcon" class="fas fa-moon"></i>
                            </button>
                        </li>
                    {% else %}
                        <li><a href="{{ url_for('login') }}"><i class="fas fa-sign-in-alt"></i> <span class="nav-text">Login</span></a></li>
                        <li><a href="{{ url_for('register') }}"><i class="fas fa-user-plus"></i> <span class="nav-text">Register</span></a></li>
                    {% endif %}
                </ul>
            </nav>
        </div>
    </header>

    <main class="app-main container">
        {% if not login_page %}
        <div class="flash-messages">
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }}">{{ message }}</div>
                    {% endfor %}
                {% endif %}
            {% endwith %}
        </div>
        {% endif %}
        {% block content %}{% endblock %}
    </main>

    {% include 'profile_password_modal.html' %}

    <footer class="app-footer">
        <div class="container">
            <p>&copy; 2025 Student Monitor. All rights reserved.</p>
        </div>
    </footer>

    {# Bootstrap JS Bundle with Popper #}
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" xintegrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    <script>
        // Function to show the universal confirmation modal
        function showUniversalConfirmationModal(actionUrl, successRedirectUrl, message, confirmText = 'Confirm') {
            const modalElement = document.getElementById('confirmDeleteModal');
            const modal = new bootstrap.Modal(modalElement);
            const modalTitle = document.getElementById('confirmDeleteModalLabel');
            const modalActionMessage = document.getElementById('modalActionMessage');
            const modalPasswordInput = document.getElementById('modalPassword');
            const confirmActionButton = document.getElementById('confirmActionButton');
            const modalFeedback = document.getElementById('modalFeedback');

            // Set modal title and message
            modalTitle.textContent = 'Confirm Action'; // Generic title
            modalActionMessage.textContent = message;
            confirmActionButton.textContent = confirmText; // Change button text
            confirmActionButton.className = confirmActionButton.className.replace(/btn-(danger|primary)/, `btn-${confirmText === 'Delete' ? 'danger' : 'primary'}`); // Dynamically set button color

            // Clear previous state
            modalPasswordInput.value = '';
            modalFeedback.textContent = ''; // Clear any previous feedback

            // Clone the button to remove all previous event listeners
            const newConfirmActionButton = confirmActionButton.cloneNode(true);
            confirmActionButton.parentNode.replaceChild(newConfirmActionButton, confirmActionButton);

            newConfirmActionButton.onclick = async function() {
                const password = modalPasswordInput.value;
                if (!password) {
                    modalFeedback.textContent = 'Password is required.';
                    return;
                }

                // Disable button and show loading
                newConfirmActionButton.disabled = true;
                newConfirmActionButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Processing...';

                try {
                    const response = await fetch(actionUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: new URLSearchParams({
                            'password': password
                        })
                    });

                    const data = await response.json(); // Expecting JSON response

                    if (data.success) {
                        modal.hide(); // Hide the modal first
                        // Add a small delay for the modal to fully close before redirecting
                        setTimeout(() => {
                            // Use window.location.replace to prevent going back after action
                            window.location.replace(data.redirect_url || successRedirectUrl || window.location.href); 
                        }, 300); 
                    } else {
                        modalFeedback.textContent = data.message || 'Action failed. Please try again.';
                        modalPasswordInput.value = ''; // Clear password on failure
                    }
                } catch (error) {
                    console.error('Error during action:', error);
                    modalFeedback.textContent = 'An error occurred. Please try again.';
                } finally {
                    // Re-enable button
                    newConfirmActionButton.disabled = false;
                    newConfirmActionButton.innerHTML = confirmText; // Reset button text
                }
            };

            modal.show();
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Mobile-specific enhancements
            const isMobile = window.innerWidth <= 768;
            
            // Add touch-friendly interactions for mobile
            if (isMobile) {
                // Increase touch targets
                document.querySelectorAll('.btn, .nav-links a').forEach(element => {
                    element.style.minHeight = '44px';
                    element.style.minWidth = '44px';
                });
                
                // Add swipe gestures for tables (if needed)
                const tables = document.querySelectorAll('.table-responsive');
                tables.forEach(table => {
                    let startX = 0;
                    let scrollLeft = 0;
                    
                    table.addEventListener('touchstart', (e) => {
                        startX = e.touches[0].pageX - table.offsetLeft;
                        scrollLeft = table.scrollLeft;
                    });
                    
                    table.addEventListener('touchmove', (e) => {
                        if (!startX) return;
                        const x = e.touches[0].pageX - table.offsetLeft;
                        const walk = (x - startX) * 2;
                        table.scrollLeft = scrollLeft - walk;
                    });
                    
                    table.addEventListener('touchend', () => {
                        startX = 0;
                    });
                });
            }

            const profileLink = document.querySelector('.nav-links a[href*="profile"]');
            if (profileLink && document.body.dataset.userType === "teacher") {
                profileLink.addEventListener('click', function(event) {
                    event.preventDefault();
                    const passwordModal = new bootstrap.Modal(document.getElementById('passwordConfirmModal'));
                    passwordModal.show();
                });
            }

            // Event listener for all delete buttons using 'delete-btn' class
            document.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', function(event) {
                    event.preventDefault(); // Prevent default form submission
                    const deleteUrl = event.currentTarget.dataset.deleteUrl;
                    const redirectUrl = event.currentTarget.dataset.redirectUrl;
                    const confirmationMessage = event.currentTarget.dataset.confirmationMessage || 'Are you sure you want to delete this item? This action cannot be undone.';
                    const itemName = event.currentTarget.dataset.itemName; 
                    
                    showUniversalConfirmationModal(
                        deleteUrl, 
                        redirectUrl, 
                        `${confirmationMessage}`, // Message from data attribute
                        'Delete' // Button text
                    );
                });
            });

            // Event listener for "Assign Teachers to Unassigned Periods" button
            const reassignTeachersBtn = document.getElementById('reassignTeachersBtn');
            if (reassignTeachersBtn) {
                reassignTeachersBtn.addEventListener('click', function() {
                    // TODO: Implement reassign_period_teachers route
                    alert('This feature is not yet implemented.');
                    const redirectUrl = '{{ url_for("admin_dashboard") }}'; // Updated to use admin_dashboard
                    const message = 'This action will attempt to assign registered teacher accounts to periods that are currently unassigned based on their grade level and specialization.';
                    // showUniversalConfirmationModal(
                    //     reassignUrl, 
                    //     redirectUrl, 
                    //     message, 
                    //     'Reassign' // Button text
                    // );
                });
            }

            // Auto-hide flash messages after 5 seconds on mobile
            if (isMobile) {
                setTimeout(() => {
                    const flashMessages = document.querySelectorAll('.alert');
                    flashMessages.forEach(message => {
                        message.style.transition = 'opacity 0.5s ease';
                        message.style.opacity = '0';
                        setTimeout(() => message.remove(), 500);
                    });
                }, 5000);
            }

            // Prevent zoom on input focus for iOS
            const inputs = document.querySelectorAll('input[type="text"], input[type="password"], input[type="email"], input[type="number"], input[type="date"], select, textarea');
            inputs.forEach(input => {
                input.addEventListener('focus', function() {
                    if (isMobile) {
                        this.style.fontSize = '16px';
                    }
                });
                
                input.addEventListener('blur', function() {
                    if (isMobile) {
                        this.style.fontSize = '';
                    }
                });
            });
        });

        function submitPassword() {
            const password = document.getElementById('adminPassword').value;
            const errorDiv = document.getElementById('passwordError');
            
            fetch("{{ url_for('verify_password_for_profile') }}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ password: password })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    setTimeout(function() {
                        window.location.href = "{{ url_for('profile') }}";
                    }, 300); // 300ms delay to allow session cookie to be set
                } else {
                    errorDiv.textContent = data.message || 'Incorrect password.';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                errorDiv.textContent = 'An error occurred. Please try again.';
            });
        }

        // Add responsive table functionality
        function makeTablesResponsive() {
            const tables = document.querySelectorAll('.data-table');
            tables.forEach(table => {
                const headers = table.querySelectorAll('th');
                const cells = table.querySelectorAll('td');
                
                headers.forEach((header, index) => {
                    const headerText = header.textContent.trim();
                    cells.forEach((cell, cellIndex) => {
                        if (cellIndex % headers.length === index) {
                            cell.setAttribute('data-label', headerText);
                        }
                    });
                });
            });
        }

        // Call on page load and window resize
        document.addEventListener('DOMContentLoaded', makeTablesResponsive);
        window.addEventListener('resize', makeTablesResponsive);
    </script>
    {% block scripts %}{% endblock %}
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Password Toggle Functionality -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Function to create password toggle button
            function createPasswordToggle(passwordInput) {
                if (passwordInput.parentElement.classList.contains('password-field-container')) {
                    return;
                }
                const container = document.createElement('div');
                container.className = 'password-field-container';
                passwordInput.parentNode.insertBefore(container, passwordInput);
                container.appendChild(passwordInput);
                const toggleBtn = document.createElement('button');
                toggleBtn.type = 'button';
                toggleBtn.className = 'password-toggle-btn';
                toggleBtn.textContent = passwordInput.type === 'password' ? 'Show' : 'Hide';
                toggleBtn.setAttribute('aria-label', 'Toggle password visibility');
                toggleBtn.style.display = passwordInput.value ? '' : 'none';
                container.appendChild(toggleBtn);
                toggleBtn.addEventListener('click', function() {
                    const isPassword = passwordInput.type === 'password';
                    passwordInput.type = isPassword ? 'text' : 'password';
                    toggleBtn.textContent = isPassword ? 'Hide' : 'Show';
                    toggleBtn.classList.toggle('show', isPassword);
                });
                passwordInput.addEventListener('input', function() {
                    toggleBtn.style.display = passwordInput.value ? '' : 'none';
                });
            }
            const passwordInputs = document.querySelectorAll('input[type="password"], input[type="text"]');
            passwordInputs.forEach(function(input) {
                if (input.type === 'password' || (input.type === 'text' && input.name && input.name.toLowerCase().includes('password'))) {
                    createPasswordToggle(input);
                }
            });
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    mutation.addedNodes.forEach(function(node) {
                        if (node.nodeType === 1) {
                            const newPasswordInputs = node.querySelectorAll ? node.querySelectorAll('input[type="password"], input[type="text"]') : [];
                            newPasswordInputs.forEach(function(input) {
                                if (input.type === 'password' || (input.type === 'text' && input.name && input.name.toLowerCase().includes('password'))) {
                                    createPasswordToggle(input);
                                }
                            });
                        }
                    });
                });
            });
            observer.observe(document.body, { childList: true, subtree: true });
        });
    </script>
    <!-- Dark mode toggle logic -->
    <script>
        function setDarkMode(enabled) {
            if (enabled) {
                document.body.classList.add('dark-mode');
                document.getElementById('darkModeIcon').classList.remove('fa-moon');
                document.getElementById('darkModeIcon').classList.add('fa-sun');
            } else {
                document.body.classList.remove('dark-mode');
                document.getElementById('darkModeIcon').classList.remove('fa-sun');
                document.getElementById('darkModeIcon').classList.add('fa-moon');
            }
        }
        document.addEventListener('DOMContentLoaded', function() {
            const darkMode = localStorage.getItem('darkMode') === 'true';
            setDarkMode(darkMode);
            const toggleBtn = document.getElementById('darkModeToggle');
            if (toggleBtn) {
                toggleBtn.addEventListener('click', function() {
                    const enabled = !document.body.classList.contains('dark-mode');
                    setDarkMode(enabled);
                    localStorage.setItem('darkMode', enabled);
                });
            }
        });
    </script>
</body>
</html>
