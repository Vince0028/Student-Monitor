{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="row mb-4">
        <div class="col">
            <h2>Attendance Details</h2>
            <p class="text-muted">
                {{ section_period.section.name }} - {{ section_period.period_name }} {{ section_period.school_year }}
                {% if section_period.section.strand %}
                    ({{ section_period.section.strand.name }})
                {% endif %}
                - {{ subject.subject_name }}
            </p>
            <p class="text-primary">
                <i class="fas fa-calendar"></i> {{ date.strftime('%B %d, %Y') }}
            </p>
        </div>
    </div>

    <!-- Search Bar -->
    <div class="row mb-4">
        <div class="col">
            <div class="input-group">
                <span class="input-group-text">
                    <i class="fas fa-search"></i>
                </span>
                <input type="text" class="form-control" id="studentSearch" placeholder="Search student name...">
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Student Attendance Status</h5>
                    {% if not show_edit %}
                    <a href="{{ url_for('teacher_section_attendance_date', section_period_id=section_period.id, subject_id=subject.id, date=date.strftime('%Y-%m-%d'), edit=1) }}" class="btn btn-sm btn-primary">
                        <i class="fas fa-edit"></i> Edit Attendance
                    </a>
                    {% endif %}
                </div>
                <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                    {% if show_edit %}
                    <form method="POST">
                        <input type="hidden" name="attendance_date" value="{{ date.strftime('%Y-%m-%d') }}">
                        <table class="table table-bordered mb-0 student-attendance-table">
                            <thead>
                                <tr>
                                    <th>Student Name</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="studentTableBody">
                                {% set boys = attendance_records | selectattr('0.gender', 'equalto', 'Male') | list %}
                                {% set girls = attendance_records | selectattr('0.gender', 'equalto', 'Female') | list %}
                                {% set unknowns = attendance_records | rejectattr('0.gender', 'equalto', 'Male') | rejectattr('0.gender', 'equalto', 'Female') | list %}
                                {% if boys %}
                                <tr class="table-group-divider"><td colspan="2" style="font-weight:bold; background:#f5f5f5;">Boys</td></tr>
                                {% for student, attendance in boys %}
                                <tr class="student-row">
                                    <td class="student-name">{{ student.name }}</td>
                                    <td class="text-center">
                                        {% for status in attendance_statuses %}
                                        <label class="me-2">
                                            <input type="radio" name="status_{{ student.id }}" value="{{ status }}" {% if attendance and attendance.status == status %}checked{% endif %} required>
                                            {{ status|capitalize }}
                                        </label>
                                        {% endfor %}
                                    </td>
                                </tr>
                                {% endfor %}
                                {% endif %}
                                {% if girls %}
                                <tr class="table-group-divider"><td colspan="2" style="font-weight:bold; background:#f5f5f5;">Girls</td></tr>
                                {% for student, attendance in girls %}
                                <tr class="student-row">
                                    <td class="student-name">{{ student.name }}</td>
                                    <td class="text-center">
                                        {% for status in attendance_statuses %}
                                        <label class="me-2">
                                            <input type="radio" name="status_{{ student.id }}" value="{{ status }}" {% if attendance and attendance.status == status %}checked{% endif %} required>
                                            {{ status|capitalize }}
                                        </label>
                                        {% endfor %}
                                    </td>
                                </tr>
                                {% endfor %}
                                {% endif %}
                                {% if unknowns %}
                                <tr class="table-group-divider"><td colspan="2" style="font-weight:bold; background:#f5f5f5;">Unknown/Other</td></tr>
                                {% for student, attendance in unknowns %}
                                <tr class="student-row">
                                    <td class="student-name">{{ student.name }}</td>
                                    <td class="text-center">
                                        {% for status in attendance_statuses %}
                                        <label class="me-2">
                                            <input type="radio" name="status_{{ student.id }}" value="{{ status }}" {% if attendance and attendance.status == status %}checked{% endif %} required>
                                            {{ status|capitalize }}
                                        </label>
                                        {% endfor %}
                                    </td>
                                </tr>
                                {% endfor %}
                                {% endif %}
                            </tbody>
                        </table>
                        <div class="mt-3 d-flex justify-content-between">
                            <button type="submit" class="btn btn-success"><i class="fas fa-save"></i> Save Changes</button>
                            <a href="{{ url_for('teacher_section_attendance_date', section_period_id=section_period.id, subject_id=subject.id, date=date.strftime('%Y-%m-%d')) }}" class="btn btn-secondary">Cancel</a>
                        </div>
                    </form>
                    {% else %}
                    <table class="table table-bordered mb-0 student-attendance-table">
                        <thead>
                            <tr>
                                <th>Student Name</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="studentTableBody">
                            {% set boys = attendance_records | selectattr('0.gender', 'equalto', 'Male') | list %}
                            {% set girls = attendance_records | selectattr('0.gender', 'equalto', 'Female') | list %}
                            {% set unknowns = attendance_records | rejectattr('0.gender', 'equalto', 'Male') | rejectattr('0.gender', 'equalto', 'Female') | list %}
                            {% if boys %}
                            <tr class="table-group-divider"><td colspan="2" style="font-weight:bold; background:#f5f5f5;">Boys</td></tr>
                            {% for student, attendance in boys %}
                            <tr class="student-row">
                                <td class="student-name">{{ student.name }}</td>
                                <td class="text-center">
                                    {% if attendance %}
                                        <span class="badge rounded-pill 
                                            {% if attendance.status == 'present' %}bg-success
                                            {% elif attendance.status == 'absent' %}bg-danger
                                            {% elif attendance.status == 'late' %}bg-warning
                                            {% else %}bg-info{% endif %}">
                                            {{ attendance.status|title }}
                                        </span>
                                    {% else %}
                                        <span class="badge rounded-pill bg-secondary">Not Recorded</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                            {% endif %}
                            {% if girls %}
                            <tr class="table-group-divider"><td colspan="2" style="font-weight:bold; background:#f5f5f5;">Girls</td></tr>
                            {% for student, attendance in girls %}
                            <tr class="student-row">
                                <td class="student-name">{{ student.name }}</td>
                                <td class="text-center">
                                    {% if attendance %}
                                        <span class="badge rounded-pill 
                                            {% if attendance.status == 'present' %}bg-success
                                            {% elif attendance.status == 'absent' %}bg-danger
                                            {% elif attendance.status == 'late' %}bg-warning
                                            {% else %}bg-info{% endif %}">
                                            {{ attendance.status|title }}
                                        </span>
                                    {% else %}
                                        <span class="badge rounded-pill bg-secondary">Not Recorded</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                            {% endif %}
                            {% if unknowns %}
                            <tr class="table-group-divider"><td colspan="2" style="font-weight:bold; background:#f5f5f5;">Unknown/Other</td></tr>
                            {% for student, attendance in unknowns %}
                            <tr class="student-row">
                                <td class="student-name">{{ student.name }}</td>
                                <td class="text-center">
                                    {% if attendance %}
                                        <span class="badge rounded-pill 
                                            {% if attendance.status == 'present' %}bg-success
                                            {% elif attendance.status == 'absent' %}bg-danger
                                            {% elif attendance.status == 'late' %}bg-warning
                                            {% else %}bg-info{% endif %}">
                                            {{ attendance.status|title }}
                                        </span>
                                    {% else %}
                                        <span class="badge rounded-pill bg-secondary">Not Recorded</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                            {% endif %}
                        </tbody>
                    </table>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Attendance Summary for the Day -->
    <div class="row mt-3">
        <div class="col">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">Attendance Summary for This Date</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <ul class="list-group list-group-flush">
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <span>Total Present</span>
                                    <span class="badge bg-success">{{ total_present }}</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <span>Total Absent</span>
                                    <span class="badge bg-danger">{{ total_absent }}</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <span>Total Late</span>
                                    <span class="badge bg-warning text-dark">{{ total_late }}</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <span>Total Excused</span>
                                    <span class="badge bg-info text-dark">{{ total_excused }}</span>
                                </li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <ul class="list-group list-group-flush">
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <span>Total Boys</span>
                                    <span class="badge bg-primary">{{ total_boys }}</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <span>Total Girls</span>
                                    <span class="badge bg-pink" style="background-color:#e83e8c;">{{ total_girls }}</span>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="mt-3">
        <a href="{{ url_for('teacher_section_attendance_history', section_period_id=section_period.id, subject_id=subject.id) }}" 
           class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Back to History
        </a>
    </div>
</div>

<style>
.input-group-text {
    background-color: #f8f9fa;
    border-right: none;
}

#studentSearch {
    border-left: none;
}

#studentSearch:focus {
    box-shadow: none;
    border-color: #ced4da;
}

.student-row.hidden {
    display: none;
}

.badge {
    font-size: 0.9em;
    padding: 8px 12px;
}

/* Scrollable Student Attendance Table */
.student-attendance-table thead th {
    position: sticky;
    top: 0;
    background: #f8f9fa;
    z-index: 2;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('studentSearch');
    const studentRows = document.getElementsByClassName('student-row');

    searchInput.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        Array.from(studentRows).forEach(row => {
            const studentName = row.querySelector('.student-name').textContent.toLowerCase();
            row.classList.toggle('hidden', !studentName.includes(searchTerm));
        });
    });
});
</script>
{% endblock %} 