{% extends 'base.html' %}
{% block title %}Manage Student Quiz{% endblock %}
{% block content %}
<div class="container" style="max-width:900px; margin:2rem auto;">
    <h2>Manage Quiz for {{ student.name }}</h2>
    <p class="text-muted">Section Period: {{ section_period_id }} | Subject: {{ subject_id }}</p>
    <hr>
    <h4>Quizzes & Attempts</h4>
    <table class="table table-bordered" style="width:100%;">
        <thead>
            <tr>
                <th>Quiz Title</th>
                <th>Score</th>
                <th>Status</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            {% for row in quiz_rows %}
            <tr>
                <td>
                    {% if row.essay_questions and row.status == 'pending' %}
                        <a href="#essay-quiz-{{ row.quiz.id }}" class="btn btn-link" style="color:#2563eb; font-weight:600; text-decoration:underline;">{{ row.quiz.title }}</a>
                    {% else %}
                        {{ row.quiz.title }}
                    {% endif %}
                </td>
                <td>
                    {% if row.attempt %}
                        {{ row.attempt.score }} / {{ row.attempt.total_points }}
                    {% else %}
                        —
                    {% endif %}
                </td>
                <td>
                    {% if row.status == 'pending' %}
                        <span style="color:#2563eb;font-weight:600;">Pending (Manual Check Required)</span>
                    {% elif row.status == 'completed' %}
                        <span style="color:#43b581;font-weight:600;">Completed</span>
                    {% else %}
                        Not Attempted
                    {% endif %}
                </td>
                <td>
                    {% if row.status == 'pending' %}
                        <a href="#essay-quiz-{{ row.quiz.id }}" class="btn btn-primary btn-sm">Check Essay</a>
                    {% else %}
                        —
                    {% endif %}
                </td>
            </tr>
            {% else %}
            <tr><td colspan="4">No quizzes found for this section/subject.</td></tr>
            {% endfor %}
        </tbody>
    </table>

    {% for row in quiz_rows %}
        {% if row.essay_questions %}
        <div id="essay-quiz-{{ row.quiz.id }}" style="margin-top:2.5rem; padding:1.5rem; background:#f8f9ff; border-radius:1rem; border:1.5px solid #e2e8f0;">
            <h5 style="font-weight:700; color:#2563eb;">Manual Scoring: {{ row.quiz.title }}</h5>
            <form method="POST" action="{{ url_for('score_student_essay', section_period_id=section_period_id, subject_id=subject_id, student_id=student.id, quiz_id=row.quiz.id) }}">
                <table class="table" style="margin-top:1rem;">
                    <thead>
                        <tr>
                            <th>Question</th>
                            <th>Student Answer</th>
                            <th>Score</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for q in row.essay_questions %}
                        <tr>
                            <td>{{ q.text }}</td>
                            <td>
                                {% set ans = (row.essay_answers | selectattr('question_id', 'equalto', q.id|string) | list | first) %}
                                {{ ans.answer_text if ans else '' }}
                            </td>
                            <td>
                                <input type="number" name="score_{{ q.id }}" min="0" max="{{ q.points or 1 }}" value="{{ ans.score if ans and ans.score is not none else '' }}" style="width:70px;">
                                <span style="color:#6b7280; font-size:0.95rem;">/ {{ q.points or 1 }}</span>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                <button type="submit" class="btn btn-success">Save Scores</button>
            </form>
        </div>
        {% endif %}
    {% endfor %}
</div>
{% endblock %} 