{% extends 'base.html' %}
{% block content %}
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        .quiz-container { max-width: 900px; margin: 0 auto; background: #fff; border-radius: 20px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.08); overflow: hidden; }
        .quiz-header { background: #374151; padding: 30px; color: #fff; text-align: center; }
        .quiz-title { font-size: 2.5rem; font-weight: 600; margin-bottom: 10px; }
        .quiz-subtitle { opacity: 0.85; font-size: 1.1rem; }
        .quiz-content { padding: 30px; }
        .quiz-form-header { background: #f7f7fa; padding: 25px; border-radius: 15px; margin-bottom: 30px; border-left: 5px solid #444; }
        .quiz-form-header h2 { color: #222; font-size: 1.8rem; margin-bottom: 10px; }
        .quiz-form-header input { border: none; background: transparent; font-size: 1.8rem; font-weight: 600; color: #222; width: 100%; padding: 10px 0; }
        .quiz-form-header input:focus { outline: none; border-bottom: 2px solid #444; }
        .question-card { background: #fff; border: 2px solid #e0e0e0; border-radius: 15px; padding: 25px; margin-bottom: 20px; position: relative; transition: all 0.3s ease; }
        .question-card:hover { border-color: #888; box-shadow: 0 10px 30px rgba(34, 34, 34, 0.08); }
        .question-card.active { border-color: #444; box-shadow: 0 10px 30px rgba(34, 34, 34, 0.12); }
        .question-header { display: flex; justify-content: between; align-items: flex-start; margin-bottom: 20px; }
        .question-number { background: #374151; color: #fff; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; margin-right: 15px; flex-shrink: 0; }
        .question-input { flex: 1; border: none; font-size: 1.2rem; padding: 10px 0; color: #222; background: transparent; border-bottom: 2px solid #444; }
        .question-input:focus { outline: none; border-bottom: 2px solid #444; }
        .question-input::placeholder { color: #aaa; }
        .question-actions { display: flex; gap: 10px; margin-left: auto; }
        .action-btn { background: none; border: none; color: #888; cursor: pointer; padding: 8px; border-radius: 8px; transition: all 0.2s; }
        .action-btn:hover { background: #f0f0f0; color: #222; }
        .delete-btn:hover { color: #e53e3e; background: #fbeaea; }
        .question-type-selector { margin-bottom: 20px; }
        .type-dropdown { background: #f7f7fa; border: 1px solid #e0e0e0; border-radius: 10px; padding: 12px 15px; font-size: 1rem; color: #222; cursor: pointer; min-width: 200px; }
        .type-dropdown:focus { outline: none; border-color: #444; }
        .options-container { space-y: 15px; }
        .option-item { display: flex; align-items: center; gap: 15px; padding: 15px; background: #f7f7fa; border-radius: 10px; margin-bottom: 10px; transition: all 0.2s; }
        .option-item:hover { background: #ededed; }
        .option-radio { width: 20px; height: 20px; border-radius: 50%; border: 2px solid #bbb; cursor: pointer; position: relative; transition: all 0.2s; }
        .option-radio.selected { border-color: #222; background: #222; }
        .option-radio.selected::after { content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 8px; height: 8px; background: #fff; border-radius: 50%; }
        .option-input { flex: 1; border: none; background: transparent; font-size: 1rem; padding: 8px 0; color: #222; }
        .option-input:focus { outline: none; }
        .option-input::placeholder { color: #aaa; }
        .remove-option { color: #888; cursor: pointer; padding: 5px; border-radius: 5px; transition: all 0.2s; }
        .remove-option:hover { color: #e53e3e; background: #fbeaea; }
        .add-option-btn { background: none; border: 2px dashed #bbb; color: #888; padding: 15px; border-radius: 10px; cursor: pointer; width: 100%; margin-top: 10px; transition: all 0.2s; }
        .add-option-btn:hover { border-color: #222; color: #222; background: #f7f7fa; }
        .short-answer-field { background: #f7f7fa; border: 2px solid #e0e0e0; border-radius: 10px; padding: 15px; margin-top: 15px; }
        .short-answer-input { width: 100%; border: none; background: transparent; font-size: 1rem; padding: 8px 0; color: #222; }
        .short-answer-input:focus { outline: none; }
        .add-question-btn { background: #374151; color: #fff; border: none; padding: 15px 30px; border-radius: 10px; font-size: 1.1rem; font-weight: 600; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; gap: 10px; margin: 20px auto; }
        .add-question-btn:hover { background: #1f2937; color: #fff; transform: translateY(-2px); box-shadow: 0 10px 30px rgba(55, 65, 81, 0.10); }
        .quiz-actions { display: flex; justify-content: space-between; align-items: center; padding: 25px; background: #f7f7fa; border-top: 1px solid #e0e0e0; }
        .btn-primary { background: #374151; color: #fff; border: none; padding: 12px 25px; border-radius: 10px; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(55, 65, 81, 0.10); background: #1f2937; }
        .btn-secondary { background: #e0e0e0; color: #222; border: none; padding: 12px 25px; border-radius: 10px; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .btn-secondary:hover { background: #bbb; }
        .empty-state { text-align: center; padding: 60px 20px; color: #888; }
        .empty-state i { font-size: 4rem; margin-bottom: 20px; opacity: 0.2; }
        .drag-handle { cursor: grab; color: #bbb; padding: 5px; }
        .drag-handle:hover { color: #222; }
        .question-card.dragging { opacity: 0.5; transform: rotate(5deg); }
        .multi-toggle-row {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        .multi-toggle-label {
            font-size: 0.95rem;
            color: #888;
            margin-right: 10px;
        }
        .multi-toggle-checkbox {
            width: 22px;
            height: 22px;
            accent-color: #222;
            margin-left: 0;
            vertical-align: middle;
            cursor: pointer;
        }
        @media (max-width: 768px) { .quiz-container { margin: 10px; border-radius: 15px; } .quiz-content { padding: 20px; } .question-card { padding: 20px; } .quiz-title { font-size: 2rem; } }
        @media (max-width: 600px) {
            .quiz-container { margin: 2vw; border-radius: 10px; }
            .quiz-header { padding: 18px 8px; }
            .quiz-title { font-size: 1.3rem; }
            .quiz-content { padding: 10px 4px; }
            .quiz-form-header { padding: 12px 6px; border-radius: 8px; margin-bottom: 18px; }
            .quiz-form-header h2 { font-size: 1.1rem; }
            .quiz-form-header input { font-size: 1.1rem; padding: 7px 0; }
            .quiz-form-header label { font-size: 0.95rem !important; }
            .quiz-form-header > div[style*='display: flex'] { flex-direction: column !important; gap: 0.5rem !important; align-items: stretch !important; }
            .quiz-form-header > div > div { width: 100% !important; }
            .quiz-form-header input[type="datetime-local"],
            .quiz-form-header input[type="number"] { width: 100% !important; min-width: 0; box-sizing: border-box; }
            .question-card { padding: 10px 4px; }
            .quiz-actions { flex-direction: column; gap: 10px; padding: 10px 4px; }
            .quiz-actions > div { width: 100%; display: flex; flex-direction: column; gap: 8px; }
            .btn-primary, .btn-secondary { width: 100%; min-width: 0; padding: 10px 0; font-size: 1em; }
        }

        /* Dark mode styles for quiz maker */
        .dark-mode .quiz-container { background: #23272f; color: #f1f1f1; }
        .dark-mode .quiz-header { background: #23272e; color: #fff; }
        .dark-mode .quiz-title { color: #fff; }
        .dark-mode .quiz-form-header { background: #23272f; border-left: 5px solid #888; }
        .dark-mode .quiz-form-header input { color: #fff; background: transparent; }
        .dark-mode .quiz-form-header input::placeholder { color: #aaa; }
        .dark-mode .question-card { background: #23272f; border: 2px solid #444; }
        .dark-mode .question-card:hover, .dark-mode .question-card.active { border-color: #888; box-shadow: 0 10px 30px rgba(0,0,0,0.18); }
        .dark-mode .question-input { color: #fff; background: transparent; border-bottom: 2px solid #888; }
        .dark-mode .question-input::placeholder { color: #aaa; }
        .dark-mode .type-dropdown { background: #23272f; color: #fff; border: 1px solid #444; }
        .dark-mode .type-dropdown:focus { border-color: #888; }
        .dark-mode .option-item { background: #23272f; }
        .dark-mode .option-input { color: #fff; background: transparent; }
        .dark-mode .option-input::placeholder { color: #aaa; }
        .dark-mode .remove-option { color: #aaa; }
        .dark-mode .remove-option:hover { color: #e53e3e; background: #2d2f36; }
        .dark-mode .add-option-btn { background: none; border: 2px dashed #444; color: #aaa; }
        .dark-mode .add-option-btn:hover { border-color: #fff; color: #fff; background: #23272f; }
        .dark-mode .short-answer-field { background: #23272f; border: 2px solid #444; }
        .dark-mode .short-answer-input { color: #fff; background: transparent; }
        .dark-mode .quiz-actions { background: #23272f; border-top: 1px solid #444; }
        .dark-mode .btn-primary { background: #23272e; color: #fff; }
        .dark-mode .btn-primary:hover { background: #374151; color: #fff; }
        .dark-mode .btn-secondary { background: #444; color: #fff; }
        .dark-mode .btn-secondary:hover { background: #888; color: #fff; }
        .dark-mode .empty-state { color: #aaa; }
        .dark-mode .empty-state i { color: #444; }
        .dark-mode .add-question-btn { background: #23272e; color: #fff; }
        .dark-mode .add-question-btn:hover { background: #374151; color: #fff; }
        .dark-mode input[type="datetime-local"],
        .dark-mode input[type="number"] {
            background: #181a1b !important;
            color: #fff !important;
            border: 1px solid #444 !important;
        }
        .dark-mode input[type="datetime-local"]::placeholder,
        .dark-mode input[type="number"]::placeholder {
            color: #aaa !important;
        }
        .dark-mode .quiz-form-header label,
        .dark-mode .quiz-form-header .help-text,
        .dark-mode .quiz-form-header div[style*='font-size:0.95rem'] {
            color: #fff !important;
        }
    </style>
    <div class="quiz-container">
        <div class="quiz-header">
            <div class="quiz-title">Quiz</div>
            <div class="quiz-subtitle">Good luck on your quiz!</div>
        </div>
        <div class="quiz-content">
            <div class="quiz-form-header">
                <input type="text" placeholder="Put your Quiz Name here..." id="quizTitle" value="">
                <div style="margin-top: 10px; color: #718096;">
                    <i class="fas fa-users"></i> Questions: <span id="questionCount">0</span>
                </div>
                <div style="margin-top: 18px; display: flex; gap: 2rem; align-items: center;">
                    <div>
                        <label for="quizDeadline" style="font-size: 1rem; color: #444;">Deadline (optional):</label><br>
                        <input type="datetime-local" id="quizDeadline" style="padding: 6px 10px; border-radius: 6px; border: 1px solid #ccc;">
                        <div style="font-size:0.95rem; color:#888; margin-top:2px;">Leave blank if you do not want a deadline.</div>
                    </div>
                    <div>
                        <label for="quizTimeLimit" style="font-size: 1rem; color: #444;">Time Limit (minutes):</label><br>
                        <input type="number" id="quizTimeLimit" min="1" style="width: 90px; padding: 6px 10px; border-radius: 6px; border: 1px solid #ccc;">
                    </div>
                </div>
            </div>
            <div id="questionsContainer">
                <!-- Questions will be added here -->
            </div>
            <div class="empty-state" id="emptyState">
                <i class="fas fa-clipboard-question"></i>
                <h3>No questions yet</h3>
                <p>Click the button below to add your first question</p>
            </div>
            <button class="add-question-btn" onclick="addQuestion()">
                <i class="fas fa-plus"></i>
                Add Question
            </button>
        </div>
        <div class="quiz-actions">
            <div>
                <button class="btn-secondary" style="margin-right: 10px;" onclick="window.location.href='/section_period/{{ subject.section_period_id }}/subject/{{ subject.id }}/gradebook'">&larr; Back to Gradebook</button>
                <button class="btn-secondary" style="margin-right: 10px;" id="saveDraftBtn">
                    <i class="fas fa-save"></i>
                    Save Draft
                </button>
                <button class="btn-primary">
                    <i class="fas fa-share"></i>
                    Publish Quiz
                </button>
            </div>
        </div>
    </div>
    <!-- Publish Result Modal -->
    <div id="publishResultModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.35); z-index:1000; align-items:center; justify-content:center;">
        <div style="background:#222; color:#fff; border-radius:12px; padding:2rem 2.5rem; max-width:350px; width:90vw; box-shadow:0 8px 32px rgba(0,0,0,0.18); text-align:center;">
            <h3 id="publishResultTitle" style="font-size:1.2rem; font-weight:700; margin-bottom:1.1rem;"></h3>
            <p id="publishResultMsg" style="margin-bottom:2rem; color:#e2e8f0;"></p>
            <button id="publishResultOkBtn" class="btn btn-primary" style="background:#3182ce; color:#fff; border:none; border-radius:8px; padding:0.6rem 1.5rem; font-weight:600; font-size:1rem; cursor:pointer;">OK</button>
        </div>
    </div>
    <!-- Inject quiz data for editing if present -->
    {% if quiz_data %}
    <script>window.existingQuiz = {{ quiz_data|tojson }};</script>
    {% else %}
    <script>window.existingQuiz = null;</script>
    {% endif %}
    <script>
        // Inject Flask variables for redirect
        const sectionPeriodId = "{{ subject.section_period_id }}";
        const subjectId = "{{ subject.id }}";
        let questions = [];
        let questionCounter = 0;
        // Pre-fill form if editing
        window.addEventListener('DOMContentLoaded', function() {
            if (window.existingQuiz) {
                document.getElementById('quizTitle').value = window.existingQuiz.title || '';
                if (window.existingQuiz.deadline) {
                    // Convert ISO to local datetime-local input format
                    let dt = new Date(window.existingQuiz.deadline);
                    let local = dt.toISOString().slice(0,16);
                    document.getElementById('quizDeadline').value = local;
                }
                if (window.existingQuiz.time_limit_minutes) {
                    document.getElementById('quizTimeLimit').value = window.existingQuiz.time_limit_minutes;
                }
                try {
                    questions = Array.isArray(window.existingQuiz.questions) ? window.existingQuiz.questions : JSON.parse(window.existingQuiz.questions);
                } catch (e) { questions = []; }
                questionCounter = questions.length > 0 ? Math.max(...questions.map(q => q.id || 0)) : 0;
                // Render all questions
                for (const q of questions) { renderQuestion(q); }
                updateEmptyState();
                updateQuestionCount();
            }
        });
        function addQuestion() {
            questionCounter++;
            const question = {
                id: questionCounter,
                text: '',
                type: 'multiple_choice',
                options: [
                    { text: '', isCorrect: false },
                    { text: '', isCorrect: false },
                    { text: '', isCorrect: false },
                    { text: '', isCorrect: false }
                ],
                correctAnswer: '',
                points: 1
            };
            questions.push(question);
            renderQuestion(question);
            updateEmptyState();
            updateQuestionCount();
        }
        function renderQuestion(question) {
            const container = document.getElementById('questionsContainer');
            const questionDiv = document.createElement('div');
            questionDiv.className = 'question-card';
            questionDiv.id = `question-${question.id}`;
            questionDiv.innerHTML = `
                <div class="question-header">
                    <div class="question-number">${questions.indexOf(question) + 1}</div>
                    <input type="text" class="question-input" placeholder="Type your question here..." value="${question.text}" onchange="updateQuestion(${question.id}, 'text', this.value)">
                    <div class="question-actions">
                        <button class="action-btn" onclick="duplicateQuestion(${question.id})" title="Copy"><i class="fas fa-copy"></i></button>
                        <button class="action-btn delete-btn" onclick="deleteQuestion(${question.id})" title="Delete"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
                <div class="question-type-selector">
                    <select class="type-dropdown" onchange="changeQuestionType(${question.id}, this.value)">
                        <option value="multiple_choice" ${question.type === 'multiple_choice' ? 'selected' : ''}><i class="fas fa-list-ul"></i> Multiple Choice</option>
                        <option value="essay_type" ${question.type === 'essay_type' ? 'selected' : ''}><i class="fas fa-font"></i> Essay Type</option>
                        <option value="true_false" ${question.type === 'true_false' ? 'selected' : ''}><i class="fas fa-check-circle"></i> True/False</option>
                    </select>
                </div>
                <div style='margin-bottom:10px;'>
                    <label style='font-size:0.95rem;color:#718096;'>Points:</label>
                    <input type='number' min='1' value='${question.points || 1}' style='width:60px;' onchange='updateQuestion(${question.id}, "points", this.value)'>
                </div>
                <div id="question-content-${question.id}">${renderQuestionContent(question)}</div>
            `;
            container.appendChild(questionDiv);
        }
        function getOptionLabel(index) {
            // Returns A, B, C, ... Z, AA, AB, etc.
            let label = '';
            index++;
            while (index > 0) {
                let rem = (index - 1) % 26;
                label = String.fromCharCode(65 + rem) + label;
                index = Math.floor((index - 1) / 26);
            }
            return label;
        }
        function renderQuestionContent(question) {
            if (question.type === 'multiple_choice') {
                let multiToggle = `<div class='multi-toggle-row'><label class='multi-toggle-label'>Allow multiple correct answers:</label><input type='checkbox' class='multi-toggle-checkbox' onchange='toggleMultiAnswer(${question.id}, this.checked)' ${question.allowMultiple ? 'checked' : ''}></div>`;
                let optionsHtml = question.options.map((option, index) => {
                    let onKeyDown = `onkeydown=\"handleOptionEnter(event, ${question.id}, ${index})\"`;
                    let label = getOptionLabel(index);
                    if (question.allowMultiple) {
                        return `<div class=\"option-item\"><span style='font-weight:600; margin-right:8px;'>${label}.</span><input type='checkbox' class='option-radio' ${option.isCorrect ? 'checked' : ''} onclick='toggleCorrectOption(${question.id}, ${index}, this.checked)'><input type=\"text\" class=\"option-input\" placeholder=\"Option ${label}\" value=\"${option.text}\" onchange=\"updateOption(${question.id}, ${index}, this.value)\" ${onKeyDown}>${question.options.length > 2 ? `<i class=\"fas fa-times remove-option\" onclick=\"removeOption(${question.id}, ${index})\"></i>` : ''}</div>`;
                    } else {
                        return `<div class=\"option-item\"><span style='font-weight:600; margin-right:8px;'>${label}.</span><div class=\"option-radio ${option.isCorrect ? 'selected' : ''}\" onclick=\"selectCorrectOption(${question.id}, ${index})\"></div><input type=\"text\" class=\"option-input\" placeholder=\"Option ${label}\" value=\"${option.text}\" onchange=\"updateOption(${question.id}, ${index}, this.value)\" ${onKeyDown}>${question.options.length > 2 ? `<i class=\"fas fa-times remove-option\" onclick=\"removeOption(${question.id}, ${index})\"></i>` : ''}</div>`;
                    }
                }).join('');
                return multiToggle + `<div class=\"options-container\">${optionsHtml}<button class=\"add-option-btn\" onclick=\"addOption(${question.id})\"><i class=\"fas fa-plus\"></i> Add option</button></div>`;
            } else if (question.type === 'essay_type') {
                return `<div class="short-answer-field"><input type="text" class="short-answer-input" placeholder="Essay Type (teacher will check answer manually)" value="${question.correctAnswer}" onchange="updateQuestion(${question.id}, 'correctAnswer', this.value)"></div>`;
            } else if (question.type === 'true_false') {
                return `<div class='options-container'>
                    <div class='option-item'>
                        <div class='option-radio ${question.correctAnswer === 'true' ? 'selected' : ''}' onclick='setTrueFalseAnswer(${question.id}, "true")'></div>
                        <span class='option-input' style='border: none; font-weight: 500;'>True</span>
                    </div>
                    <div class='option-item'>
                        <div class='option-radio ${question.correctAnswer === 'false' ? 'selected' : ''}' onclick='setTrueFalseAnswer(${question.id}, "false")'></div>
                        <span class='option-input' style='border: none; font-weight: 500;'>False</span>
                    </div>
                </div>`;
            }
        }
        function setTrueFalseAnswer(questionId, value) {
            const question = questions.find(q => q.id === questionId);
            if (question) {
                question.correctAnswer = value;
                document.getElementById(`question-content-${questionId}`).innerHTML = renderQuestionContent(question);
            }
        }
        function updateQuestion(questionId, field, value) { const question = questions.find(q => q.id === questionId); if (question) { question[field] = value; } }
        function updateOption(questionId, optionIndex, value) { const question = questions.find(q => q.id === questionId); if (question && question.options[optionIndex]) { question.options[optionIndex].text = value; } }
        function selectCorrectOption(questionId, optionIndex) { const question = questions.find(q => q.id === questionId); if (question) { question.options.forEach((option, index) => { option.isCorrect = index === optionIndex; }); document.getElementById(`question-content-${questionId}`).innerHTML = renderQuestionContent(question); } }
        function addOption(questionId, focusNew = false) {
            updateOptionInputsToModel(questionId);
            const question = questions.find(q => q.id === questionId);
            if (question) {
                question.options.push({ text: '', isCorrect: false });
                document.getElementById(`question-content-${questionId}`).innerHTML = renderQuestionContent(question);
                if (focusNew) {
                    setTimeout(() => {
                        const newInputs = Array.from(document.querySelectorAll(`#question-${questionId} .option-input`));
                        if (newInputs.length > 0) {
                            newInputs[newInputs.length - 1].focus();
                        }
                    }, 10);
                }
            }
        }
        function removeOption(questionId, optionIndex) { const question = questions.find(q => q.id === questionId); if (question && question.options.length > 2) { question.options.splice(optionIndex, 1); document.getElementById(`question-content-${questionId}`).innerHTML = renderQuestionContent(question); } }
        function changeQuestionType(questionId, newType) {
            const question = questions.find(q => q.id === questionId);
            if (question) {
                question.type = newType;
                if (newType === 'multiple_choice') {
                    question.options = [
                        { text: '', isCorrect: false },
                        { text: '', isCorrect: false },
                        { text: '', isCorrect: false },
                        { text: '', isCorrect: false }
                    ];
                } else if (newType === 'true_false') {
                    question.correctAnswer = 'true';
                }
                document.getElementById(`question-content-${questionId}`).innerHTML = renderQuestionContent(question);
            }
        }
        function deleteQuestion(questionId) { questions = questions.filter(q => q.id !== questionId); document.getElementById(`question-${questionId}`).remove(); updateQuestionNumbers(); updateEmptyState(); updateQuestionCount(); }
        function duplicateQuestion(questionId) {
            const question = questions.find(q => q.id === questionId);
            if (question) {
                questionCounter++;
                const duplicatedQuestion = {
                    ...question,
                    id: questionCounter,
                    text: question.text,
                    options: question.options ? question.options.map(opt => ({...opt})) : []
                };
                questions.push(duplicatedQuestion);
                renderQuestion(duplicatedQuestion);
                updateQuestionCount();
            }
        }
        function updateQuestionNumbers() { questions.forEach((question, index) => { const questionElement = document.getElementById(`question-${question.id}`); if (questionElement) { const numberElement = questionElement.querySelector('.question-number'); numberElement.textContent = index + 1; } }); }
        function updateEmptyState() { const emptyState = document.getElementById('emptyState'); emptyState.style.display = questions.length === 0 ? 'block' : 'none'; }
        function updateQuestionCount() { document.getElementById('questionCount').textContent = questions.length; }
        function toggleMultiAnswer(questionId, checked) {
            const question = questions.find(q => q.id === questionId);
            if (question) {
                question.allowMultiple = checked;
                if (!checked) {
                    let found = false;
                    question.options.forEach(opt => {
                        if (opt.isCorrect && !found) { found = true; } else { opt.isCorrect = false; }
                    });
                }
                document.getElementById(`question-content-${questionId}`).innerHTML = renderQuestionContent(question);
            }
        }
        function toggleCorrectOption(questionId, optionIndex, checked) {
            const question = questions.find(q => q.id === questionId);
            if (question && question.allowMultiple) {
                question.options[optionIndex].isCorrect = checked;
            }
        }
        function updateOptionInputsToModel(questionId) {
            const question = questions.find(q => q.id === questionId);
            if (question) {
                const optionInputs = Array.from(document.querySelectorAll(`#question-${questionId} .option-input`));
                optionInputs.forEach((input, idx) => {
                    if (question.options[idx]) {
                        question.options[idx].text = input.value;
                    }
                });
            }
        }
        function handleOptionEnter(event, questionId, optionIndex) {
            if (event.key === 'Enter') {
                event.preventDefault();
                updateOptionInputsToModel(questionId);
                const optionInputs = Array.from(document.querySelectorAll(`#question-${questionId} .option-input`));
                if (optionIndex < optionInputs.length - 1) {
                    optionInputs[optionIndex + 1].focus();
                } else {
                    addOption(questionId, true);
                }
            }
        }
        // Initialize with empty state
        updateEmptyState();
        updateQuestionCount();
        document.getElementById('saveDraftBtn').addEventListener('click', function() {
            // Gather quiz data as in publish, but set status to 'draft'
            const quizTitle = document.getElementById('quizTitle').value.trim();
            const quizDeadline = document.getElementById('quizDeadline').value;
            const quizTimeLimit = document.getElementById('quizTimeLimit').value;
            const sectionPeriodId = '{{ subject.section_period_id }}';
            const subjectId = '{{ subject.id }}';
            const data = {
                title: quizTitle,
                questions: questions,
                section_period_id: sectionPeriodId,
                subject_id: subjectId,
                deadline: quizDeadline,
                time_limit_minutes: quizTimeLimit,
                status: 'draft'
            };
            fetch('/api/quizzes', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                const modal = document.getElementById('publishResultModal');
                const title = document.getElementById('publishResultTitle');
                const msg = document.getElementById('publishResultMsg');
                const okBtn = document.getElementById('publishResultOkBtn');
                if (data.success) {
                    title.textContent = 'Draft Saved!';
                    msg.textContent = 'Your quiz draft has been saved. You can continue editing or publish it later.';
                    okBtn.onclick = function() { window.location.reload(); };
                } else {
                    title.textContent = 'Error';
                    msg.textContent = data.message || 'Failed to save draft.';
                    okBtn.onclick = function() { modal.style.display = 'none'; };
                }
                modal.style.display = 'flex';
            })
            .catch(err => {
                const modal = document.getElementById('publishResultModal');
                const title = document.getElementById('publishResultTitle');
                const msg = document.getElementById('publishResultMsg');
                const okBtn = document.getElementById('publishResultOkBtn');
                title.textContent = 'Network Error';
                msg.textContent = 'Network error: ' + err.message;
                okBtn.onclick = function() { modal.style.display = 'none'; };
                modal.style.display = 'flex';
            });
        });
        document.querySelector('.btn-primary').addEventListener('click', function() {
            const quizTitle = document.getElementById('quizTitle').value.trim();
            const quizDeadline = document.getElementById('quizDeadline').value;
            const quizTimeLimit = document.getElementById('quizTimeLimit').value;
            const modal = document.getElementById('publishResultModal');
            const title = document.getElementById('publishResultTitle');
            const msg = document.getElementById('publishResultMsg');
            const okBtn = document.getElementById('publishResultOkBtn');
            function showModal(modalTitle, modalMsg) {
                title.textContent = modalTitle;
                msg.textContent = modalMsg;
                modal.style.display = 'flex';
                okBtn.onclick = function() { modal.style.display = 'none'; };
            }
            if (!quizTitle) {
                showModal('Validation Error', 'Quiz title is required!');
                return;
            }
            if (questions.length === 0) {
                showModal('Validation Error', 'Please add at least one question.');
                return;
            }
            for (let i = 0; i < questions.length; i++) {
                const q = questions[i];
                if (!q.text || q.text.trim() === "") {
                    showModal('Validation Error', `Please enter a question for Question ${i + 1}.`);
                    return;
                }
                if (q.type === 'multiple_choice') {
                    if (q.allowMultiple) {
                        if (!q.options.some(opt => opt.isCorrect)) {
                            showModal('Validation Error', 'At least one multiple choice question has no correct answer selected.');
                            return;
                        }
                    } else {
                        if (!q.options.some(opt => opt.isCorrect)) {
                            showModal('Validation Error', 'At least one multiple choice question has no correct answer selected.');
                            return;
                        }
                    }
                }
                if (q.type === 'essay_type' && (!q.correctAnswer || !q.correctAnswer.trim())) {
                    showModal('Validation Error', 'At least one essay type question has no correct answer.');
                    return;
                }
                if (q.type === 'true_false' && (!q.correctAnswer || (q.correctAnswer !== 'true' && q.correctAnswer !== 'false'))) {
                    showModal('Validation Error', 'At least one true/false question has no correct answer.');
                    return;
                }
            }
            const data = {
                title: quizTitle,
                questions: questions,
                section_period_id: sectionPeriodId,
                subject_id: subjectId,
                deadline: quizDeadline,
                time_limit_minutes: quizTimeLimit,
                status: 'published'
            };
            fetch('/api/quizzes', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    title.textContent = 'Quiz Published!';
                    msg.textContent = 'Quiz published successfully!';
                    modal.style.display = 'flex';
                    okBtn.onclick = function() {
                        window.location.href = `/section_period/${sectionPeriodId}/subject/${subjectId}/gradebook`;
                    };
                } else {
                    title.textContent = 'Publish Failed';
                    msg.textContent = 'Failed to publish quiz: ' + (data.message || 'Unknown error');
                    modal.style.display = 'flex';
                    okBtn.onclick = function() {
                        modal.style.display = 'none';
                    };
                }
            })
            .catch(err => {
                title.textContent = 'Network Error';
                msg.textContent = 'Network error: ' + err.message;
                modal.style.display = 'flex';
                okBtn.onclick = function() {
                    modal.style.display = 'none';
                };
            });
        });
    </script>
{% endblock %} 