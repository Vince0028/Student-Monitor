{% extends 'base.html' %}
{% block title %}Quiz Manager{% endblock %}
{% block custom_css %}
<!-- Use only student_style.css for all card and layout styles -->
<style>
.student-table {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0;
}
.student-table th, .student-table td {
  padding: 1rem 0.7rem;
  text-align: left;
  font-size: 1rem;
  vertical-align: middle;
}
.student-table th {
  color: #6b7280;
  font-weight: 600;
  background: none;
  border-bottom: 2px solid #f1f1f1;
}
.student-table td {
  border-bottom: 1px solid #f1f1f1;
  background: none;
}
.student-table tr:last-child td {
  border-bottom: none;
}
.student-table .student-avatar {
  width: 38px;
  height: 38px;
  border-radius: 50%;
  background: #f1f1f1;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  font-size: 1.2rem;
  color: #bdbdbd;
  margin-right: 0.8rem;
}
.student-table .stat-badge {
  margin-left: 0.3rem;
}
.student-table .view-btn {
  background: #f3f4f6;
  border: none;
  border-radius: 0.7rem;
  padding: 0.5rem 1.1rem;
  font-size: 1rem;
  color: #2563eb;
  font-weight: 600;
  cursor: pointer;
  transition: background 0.2s;
}
.student-table .view-btn:hover {
  background: #e0e7ff;
}
.student-table tr:hover td {
  background: #f9fafb;
}
/* Make summary card numbers white in dark mode */
.dark-mode .summary-card .value {
    color: #fff !important;
}
</style>
{% endblock %}
{% block content %}
<div class="container" style="max-width:1200px; margin:0 auto; padding-top:2.5rem;">
    <h2 style="font-size:2.2rem; font-weight:700; margin-bottom:0.2rem;">Quiz Manager</h2>
    <p class="text-muted" style="color:#6b7280; margin-bottom:2.2rem;">Monitor student performance and quiz results</p>
    <div class="summary-cards" style="display:grid; grid-template-columns:repeat(4,1fr); gap:1.5rem; margin-bottom:2.2rem;">
        <div class="summary-card" style="background:#fff; border-radius:1rem; box-shadow:0 2px 8px rgba(0,0,0,0.06); padding:1.5rem 2rem 1.5rem 1.5rem; display:flex; flex-direction:row; align-items:center; border:1.5px solid #f1f1f1;">
            <div>
                <div class="label" style="color:#6b7280; font-size:1rem; margin-bottom:0.2rem; font-weight:500;">Total Students</div>
                <div class="value" style="font-size:1.7rem; font-weight:700; margin-bottom:0.1rem;">{{ total_students }}</div>
            </div>
            <div class="icon" style="font-size:2rem; color:#bdbdbd; margin-left:auto; opacity:0.7;"><i class="fas fa-users"></i></div>
        </div>
        <div class="summary-card" style="background:#fff; border-radius:1rem; box-shadow:0 2px 8px rgba(0,0,0,0.06); padding:1.5rem 2rem 1.5rem 1.5rem; display:flex; flex-direction:row; align-items:center; border:1.5px solid #f1f1f1;">
            <div>
                <div class="label" style="color:#6b7280; font-size:1rem; margin-bottom:0.2rem; font-weight:500;">Total Quizzes</div>
                <div class="value" style="font-size:1.7rem; font-weight:700; margin-bottom:0.1rem;">{{ total_quizzes }}</div>
            </div>
            <div class="icon" style="font-size:2rem; color:#bdbdbd; margin-left:auto; opacity:0.7;"><i class="fas fa-clipboard-list"></i></div>
        </div>
        <div class="summary-card" style="background:#fff; border-radius:1rem; box-shadow:0 2px 8px rgba(0,0,0,0.06); padding:1.5rem 2rem 1.5rem 1.5rem; display:flex; flex-direction:row; align-items:center; border:1.5px solid #f1f1f1;">
            <div>
                <div class="label" style="color:#6b7280; font-size:1rem; margin-bottom:0.2rem; font-weight:500;">Class Average</div>
                <div class="value" style="font-size:1.7rem; font-weight:700; margin-bottom:0.1rem;">{{ class_average }}</div>
            </div>
            <div class="icon" style="font-size:2rem; color:#bdbdbd; margin-left:auto; opacity:0.7;"><i class="fas fa-chart-line"></i></div>
        </div>
        <div class="summary-card">
            <div class="label">Recent Activity</div>
            <div class="value" style="font-size:1.7rem; font-weight:700; margin-bottom:0.1rem;">{{ recent_activity }}/{{ recent_activity_denominator }}</div>
            <div class="desc">submissions</div>
            <span class="icon"><i class="fas fa-clock"></i></span>
        </div>
    </div>
    <div style="margin-bottom:2.2rem; max-height: 260px; overflow-y: auto; border-radius: 10px; border: 1px solid #f1f1f1;">
        <h3 style="font-size:1.2rem; font-weight:700; margin-bottom:0.7rem;">Quiz Status</h3>
        <ul style="list-style:none; padding:0; margin:0; max-width:600px;">
            {% for quiz in quizzes %}
            <li style="display:flex; align-items:center; gap:1.1rem; padding:0.7rem 0; border-bottom:1px solid #f1f1f1;">
                {% if quiz.status == 'draft' %}
                    <span style="font-size:1.3rem;"><i class="fas fa-edit" style="color:#f59e42;"></i></span>
                    <span style="font-weight:600; flex:1;">{{ quiz.title }}</span>
                    <span style="color:#f59e42; font-weight:600;">Unfinished (Draft)</span>
                    <a href="{{ url_for('quiz_maker', section_period_id=quiz.section_period_id, subject_id=quiz.subject_id) }}?edit={{ quiz.id }}" class="btn btn-sm btn-secondary" style="margin-left:1rem;">Edit</a>
                {% elif quiz_status_map[quiz.id] == 'pending' %}
                    <span style="font-size:1.3rem;"><i class="fas fa-hourglass-half" style="color:#2563eb;"></i></span>
                    <span style="font-weight:600; flex:1;">{{ quiz.title }}</span>
                    <span style="color:#2563eb; font-weight:600;">Pending (Manual Check Required)</span>
                {% else %}
                    <span style="font-size:1.3rem;"><i class="fas fa-check-circle" style="color:#38d39f;"></i></span>
                    <span style="font-weight:600; flex:1;">{{ quiz.title }}</span>
                    <span style="color:#38d39f; font-weight:600;">Completed</span>
                {% endif %}
                <button class="delete-quiz-btn" data-quiz-id="{{ quiz.id }}" style="background:none; border:none; color:#e53e3e; font-size:1.2rem; cursor:pointer; margin-left:0.7rem;" title="Delete Quiz"><i class="fas fa-trash"></i></button>
            </li>
            {% endfor %}
        </ul>
    </div>
    <div class="search-filter-row" style="display:flex; align-items:center; gap:1rem; margin-bottom:1.5rem;">
        <div class="search-box" style="flex:1; max-width:350px; position:relative;">
            <input type="text" placeholder="Search students..." id="studentSearch" style="width:100%; padding:0.7rem 2.5rem 0.7rem 1rem; border-radius:0.7rem; border:1px solid #d1d5db; font-size:1rem; background:#fafbfc;">
            <i class="fas fa-search" style="position:absolute; right:1rem; top:50%; transform:translateY(-50%); color:#bdbdbd;"></i>
        </div>
    </div>
    {% set boys = students | selectattr('gender', 'equalto', 'Male') | list %}
    {% set girls = students | selectattr('gender', 'equalto', 'Female') | list %}
    {% set scroll_style = 'max-height: 320px; overflow-y: auto; border: 1px solid #f1f1f1;' if students|length > 4 else '' %}
    <div class="students-section" style="background:#fff; border-radius:1rem; box-shadow:0 2px 8px rgba(0,0,0,0.04); padding:2rem; {{ scroll_style }}">
        <h2 style="font-size:1.3rem; font-weight:700; margin-bottom:0.5rem;">Students</h2>
        <p style="color:#6b7280; font-size:1rem; margin-bottom:1.5rem;">Monitor all student quiz performance</p>
        <table class="student-table" style="width:100%; table-layout:auto;">
            <thead>
                <tr>
                    <th style="text-align:left;">Name</th>
                    <th style="text-align:left;">Email</th>
                    <th style="text-align:center;">Average</th>
                    <th style="text-align:center;">Progress</th>
                    <th style="text-align:center;"></th>
                </tr>
            </thead>
            <tbody id="studentList">
                {% if boys %}
                <tr class="table-group-divider"><td colspan="5" style="font-weight:bold; background:#f5f5f5;">Boys</td></tr>
                {% for student in boys %}
                <tr>
                    <td>
                        <span class="student-avatar"><i class="fas fa-user"></i></span>
                        <span class="name" style="font-weight:600; font-size:1.1rem;">{{ student.name }}</span>
                    </td>
                    <td><span class="email" style="color:#6b7280; font-size:0.97rem;">{{ student.email if student.email else '' }}</span></td>
                    <td style="text-align:center;"><span class="stat-badge badge-blue">{{ student.average_grade if student.average_grade is not none else 'N/A' }}%</span></td>
                    <td style="text-align:center;"><span class="stat-value">{{ student.progress if student.progress else 'N/A' }}</span></td>
                    <td style="text-align:center;"><a class="view-btn" href="{{ url_for('manage_student_quiz', section_period_id=section_period_id, subject_id=subject_id, student_id=student.id) }}"><i class="fas fa-eye"></i> View</a></td>
                </tr>
                {% endfor %}
                {% endif %}
                {% if girls %}
                <tr class="table-group-divider"><td colspan="5" style="font-weight:bold; background:#f5f5f5;">Girls</td></tr>
                {% for student in girls %}
                <tr>
                    <td>
                        <span class="student-avatar"><i class="fas fa-user"></i></span>
                        <span class="name" style="font-weight:600; font-size:1.1rem;">{{ student.name }}</span>
                    </td>
                    <td><span class="email" style="color:#6b7280; font-size:0.97rem;">{{ student.email if student.email else '' }}</span></td>
                    <td style="text-align:center;"><span class="stat-badge badge-blue">{{ student.average_grade if student.average_grade is not none else 'N/A' }}%</span></td>
                    <td style="text-align:center;"><span class="stat-value">{{ student.progress if student.progress else 'N/A' }}</span></td>
                    <td style="text-align:center;"><a class="view-btn" href="{{ url_for('manage_student_quiz', section_period_id=section_period_id, subject_id=subject_id, student_id=student.id) }}"><i class="fas fa-eye"></i> View</a></td>
                </tr>
                {% endfor %}
                {% endif %}
            </tbody>
        </table>
    </div>
</div>
<div style="display: flex; justify-content: center; margin-top: 2.5rem;">
    <a href="{{ url_for('manage_subject_grades', section_period_id=section_period_id, subject_id=subject_id) }}" class="btn btn-outline-secondary">&larr; Back to Gradebook</a>
</div>
<!-- Delete Confirmation Modal -->
<div id="deleteQuizModal" class="modal-overlay" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.35); z-index:1000; align-items:center; justify-content:center;">
  <div class="modal-content" style="background:#222; color:#fff; border-radius:12px; padding:2rem 2.5rem; max-width:350px; width:90vw; box-shadow:0 8px 32px rgba(0,0,0,0.18); text-align:center;">
    <h3 style="font-size:1.2rem; font-weight:700; margin-bottom:1.1rem;">Delete Quiz?</h3>
    <p style="margin-bottom:2rem; color:#e2e8f0;">Are you sure you want to delete this quiz? This action cannot be undone.</p>
    <div style="display:flex; gap:1.2rem; justify-content:center;">
      <button id="confirmDeleteQuizBtn" class="btn btn-danger" style="background:#e53e3e; color:#fff; border:none; border-radius:8px; padding:0.6rem 1.5rem; font-weight:600; font-size:1rem; cursor:pointer;">OK</button>
      <button id="cancelDeleteQuizBtn" class="btn btn-secondary" style="background:#2d3748; color:#fff; border:none; border-radius:8px; padding:0.6rem 1.5rem; font-weight:600; font-size:1rem; cursor:pointer;">Cancel</button>
    </div>
  </div>
</div>
<script>
    // Simple search filter for students
    document.getElementById('studentSearch').addEventListener('input', function() {
        const filter = this.value.toLowerCase();
        document.querySelectorAll('#studentList tr').forEach(function(row) {
            // Skip group header rows
            if (row.classList.contains('table-group-divider')) return;
            const name = row.querySelector('.name') ? row.querySelector('.name').textContent.toLowerCase() : '';
            const email = row.querySelector('.email') ? row.querySelector('.email').textContent.toLowerCase() : '';
            row.style.display = (name.includes(filter) || email.includes(filter)) ? '' : 'none';
        });
    });

    // Quiz delete button logic with custom modal
    let quizToDelete = null;
    const modal = document.getElementById('deleteQuizModal');
    const confirmBtn = document.getElementById('confirmDeleteQuizBtn');
    const cancelBtn = document.getElementById('cancelDeleteQuizBtn');
    document.querySelectorAll('.delete-quiz-btn').forEach(function(btn) {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            quizToDelete = this.getAttribute('data-quiz-id');
            modal.style.display = 'flex';
        });
    });
    confirmBtn.addEventListener('click', function() {
        if (!quizToDelete) return;
        fetch(`/teacher/section_period/{{ section_period_id }}/subject/{{ subject_id }}/quiz/${quizToDelete}/delete`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': '{{ csrf_token() if csrf_token is defined else '' }}'
            },
            body: JSON.stringify({})
        })
        .then(response => response.json())
        .then(data => {
            modal.style.display = 'none';
            quizToDelete = null;
            if (data.success) {
                window.location.reload();
            } else {
                alert(data.message || 'Failed to delete quiz.');
            }
        })
        .catch(() => {
            modal.style.display = 'none';
            quizToDelete = null;
            alert('Failed to delete quiz.');
        });
    });
    cancelBtn.addEventListener('click', function() {
        modal.style.display = 'none';
        quizToDelete = null;
    });
    // Optional: close modal on outside click
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            modal.style.display = 'none';
            quizToDelete = null;
        }
    });
</script>
{% endblock %}