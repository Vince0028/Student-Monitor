{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="row mb-4">
        <div class="col">
            <h2>Attendance History</h2>
            <p class="text-muted">
                {{ section_period.section.name }} - {{ section_period.period_name }} {{ section_period.school_year }}
                {% if section_period.section.strand %}
                    ({{ section_period.section.strand.name }})
                {% endif %}
                - {{ subject.subject_name }}
            </p>
        </div>
    </div>

    <!-- Search Bar -->
    <div class="row mb-4">
        <div class="col">
            <div class="input-group">
                <span class="input-group-text">
                    <i class="fas fa-search"></i>
                </span>
                <input type="text" class="form-control" id="studentSearch" placeholder="Search student name...">
            </div>
        </div>
    </div>

    <!-- Summary Statistics -->
    <div class="row mb-4">
        <div class="col">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Attendance Summary</h5>
                </div>
                <div class="card-body">
                    <div class="mb-2">
                        {# Removed Boys Present and Girls Present badges #}
                    </div>
                </div>
                <div class="table-responsive" style="max-height: 350px; overflow-y: auto;">
                    <table class="table table-bordered mb-0 attendance-summary-table">
                        <thead>
                            <tr>
                                <th>Student Name</th>
                                <th class="text-center text-success">Present</th>
                                <th class="text-center text-danger">Absent</th>
                                <th class="text-center text-warning">Late</th>
                                <th class="text-center text-info">Excused</th>
                                <th class="text-center">Attendance Rate</th>
                            </tr>
                        </thead>
                        <tbody id="summaryTableBody">
                            {% set boys = summary | selectattr('gender', 'equalto', 'Male') | list %}
                            {% set girls = summary | selectattr('gender', 'equalto', 'Female') | list %}
                            {% set unknowns = summary | rejectattr('gender', 'equalto', 'Male') | rejectattr('gender', 'equalto', 'Female') | list %}
                            {% if boys %}
                            <tr class="table-group-divider"><td colspan="6" style="font-weight:bold; background:#f5f5f5;">Boys</td></tr>
                            {% for student in boys %}
                            <tr class="student-row">
                                <td class="student-name">{{ student.name }}</td>
                                <td class="text-center">{{ student.present_count }}</td>
                                <td class="text-center">{{ student.absent_count }}</td>
                                <td class="text-center">{{ student.late_count }}</td>
                                <td class="text-center">{{ student.excused_count }}</td>
                                <td class="text-center">
                                    {% set total = student.present_count + student.absent_count + student.late_count + student.excused_count %}
                                    {% if total > 0 %}
                                        {{ "%.1f"|format((student.present_count + student.late_count) / total * 100) }}%
                                    {% else %}
                                        N/A
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                            {% endif %}
                            {% if girls %}
                            <tr class="table-group-divider"><td colspan="6" style="font-weight:bold; background:#f5f5f5;">Girls</td></tr>
                            {% for student in girls %}
                            <tr class="student-row">
                                <td class="student-name">{{ student.name }}</td>
                                <td class="text-center">{{ student.present_count }}</td>
                                <td class="text-center">{{ student.absent_count }}</td>
                                <td class="text-center">{{ student.late_count }}</td>
                                <td class="text-center">{{ student.excused_count }}</td>
                                <td class="text-center">
                                    {% set total = student.present_count + student.absent_count + student.late_count + student.excused_count %}
                                    {% if total > 0 %}
                                        {{ "%.1f"|format((student.present_count + student.late_count) / total * 100) }}%
                                    {% else %}
                                        N/A
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                            {% endif %}
                            {% if unknowns %}
                            <tr class="table-group-divider"><td colspan="6" style="font-weight:bold; background:#f5f5f5;">Unknown/Other</td></tr>
                            {% for student in unknowns %}
                            <tr class="student-row">
                                <td class="student-name">{{ student.name }}</td>
                                <td class="text-center">{{ student.present_count }}</td>
                                <td class="text-center">{{ student.absent_count }}</td>
                                <td class="text-center">{{ student.late_count }}</td>
                                <td class="text-center">{{ student.excused_count }}</td>
                                <td class="text-center">
                                    {% set total = student.present_count + student.absent_count + student.late_count + student.excused_count %}
                                    {% if total > 0 %}
                                        {{ "%.1f"|format((student.present_count + student.late_count) / total * 100) }}%
                                    {% else %}
                                        N/A
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Date-wise Attendance Records -->
    <div class="row">
        <div class="col">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Daily Attendance Records</h5>
                    <span class="text-muted">Total Attendance Days: <strong>{{ attendance_days_count }}</strong></span>
                    <div class="input-group" style="width: 200px;">
                        <input type="date" class="form-control" id="dateFilter">
                    </div>
                </div>
                <div class="table-responsive" style="max-height: 250px; overflow-y: auto;">
                    <table class="table table-bordered mb-0 daily-attendance-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Present</th>
                                <th>Absent</th>
                                <th>Late</th>
                                <th>Excused</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="dateTableBody">
                            {% for date in dates %}
                            <tr class="date-row">
                                <td class="date-value">{{ date.date.strftime('%Y-%m-%d') }}</td>
                                <td class="text-center">{{ date.present_count }}</td>
                                <td class="text-center">{{ date.absent_count }}</td>
                                <td class="text-center">{{ date.late_count }}</td>
                                <td class="text-center">{{ date.excused_count }}</td>
                                <td class="text-center">
                                    <a href="{{ url_for('teacher_section_attendance_date', section_period_id=section_period.id, subject_id=subject.id, date=date.date.strftime('%Y-%m-%d')) }}" 
                                       class="btn btn-sm btn-primary">
                                        View Details
                                    </a>
                                    <button class="btn btn-sm btn-danger ms-1 delete-attendance-btn" data-date="{{ date.date.strftime('%Y-%m-%d') }}">
                                        Delete
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="mt-3">
        <a href="{{ url_for('teacher_section_attendance_details', section_period_id=section_period.id, subject_id=subject.id) }}" 
           class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Back to Attendance Form
        </a>
    </div>
</div>

<!-- Delete Attendance Modal -->
<div class="modal fade" id="deleteAttendanceModal" tabindex="-1" aria-labelledby="deleteAttendanceModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteAttendanceModalLabel">Delete Attendance Record</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        Are you sure you want to delete all attendance records for <span id="deleteAttendanceDate"></span>? This action cannot be undone.
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="confirmDeleteAttendanceBtn">Delete</button>
      </div>
    </div>
  </div>
</div>

<!-- Toast Notification for Delete -->
<div class="position-fixed top-0 start-50 translate-middle-x p-3" style="z-index: 9999">
  <div id="deleteToast" class="toast align-items-center text-bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex">
      <div class="toast-body" id="deleteToastBody">
        <!-- Message will go here -->
      </div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
  </div>
</div>

<style>
.input-group-text {
    background-color: #f8f9fa;
    border-right: none;
}

#studentSearch, #dateFilter {
    border-left: none;
}

#studentSearch:focus, #dateFilter:focus {
    box-shadow: none;
    border-color: #ced4da;
}

.student-row.hidden, .date-row.hidden {
    display: none;
}

/* Scrollable Attendance Summary Table */
.attendance-summary-table thead th {
    position: sticky;
    top: 0;
    background: #f8f9fa;
    z-index: 2;
}

/* Scrollable Daily Attendance Records Table */
.daily-attendance-table thead th {
    position: sticky;
    top: 0;
    background: #f8f9fa;
    z-index: 2;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Student search functionality
    const studentSearch = document.getElementById('studentSearch');
    const studentRows = document.getElementsByClassName('student-row');

    studentSearch.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        Array.from(studentRows).forEach(row => {
            const studentName = row.querySelector('.student-name').textContent.toLowerCase();
            row.classList.toggle('hidden', !studentName.includes(searchTerm));
        });
    });

    // Date filter functionality
    const dateFilter = document.getElementById('dateFilter');
    const dateRows = document.getElementsByClassName('date-row');

    dateFilter.addEventListener('input', function() {
        const filterDate = this.value;
        Array.from(dateRows).forEach(row => {
            const dateValue = row.querySelector('.date-value').textContent;
            row.classList.toggle('hidden', filterDate && dateValue !== filterDate);
        });
    });

    // Delete attendance logic
    let deleteDate = null;
    let deleteRow = null;
    let deleteBtn = null;
    const deleteModal = new bootstrap.Modal(document.getElementById('deleteAttendanceModal'));
    const deleteAttendanceDate = document.getElementById('deleteAttendanceDate');
    const confirmDeleteAttendanceBtn = document.getElementById('confirmDeleteAttendanceBtn');
    const deleteToastEl = document.getElementById('deleteToast');
    const deleteToastBody = document.getElementById('deleteToastBody');

    document.querySelectorAll('.delete-attendance-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            deleteDate = this.getAttribute('data-date');
            deleteRow = this.closest('tr');
            deleteBtn = this;
            deleteAttendanceDate.textContent = deleteDate;
            deleteModal.show();
        });
    });

    confirmDeleteAttendanceBtn.addEventListener('click', function() {
        if (!deleteDate) return;
        // Show loading spinner on the delete button
        if (deleteBtn) {
            deleteBtn.disabled = true;
            deleteBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Deleting...';
        }
        confirmDeleteAttendanceBtn.disabled = true;
        confirmDeleteAttendanceBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Deleting...';
        fetch("{{ url_for('delete_attendance_date', section_period_id=section_period.id, subject_id=subject.id) }}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest',
            },
            body: JSON.stringify({ date: deleteDate })
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                if (deleteRow) deleteRow.remove();
                deleteModal.hide();
                // Show toast notification
                deleteToastBody.textContent = `Attendance for ${deleteDate} deleted successfully.`;
                const toast = new bootstrap.Toast(deleteToastEl, { delay: 2000, autohide: true });
                toast.show();
                setTimeout(function() { window.location.reload(); }, 1500);
            } else {
                alert(data.message || 'Failed to delete attendance record.');
            }
        })
        .catch(() => {
            alert('An error occurred while deleting the attendance record.');
        })
        .finally(() => {
            // Restore button state
            if (deleteBtn) {
                deleteBtn.disabled = false;
                deleteBtn.innerHTML = 'Delete';
            }
            confirmDeleteAttendanceBtn.disabled = false;
            confirmDeleteAttendanceBtn.innerHTML = 'Delete';
        });
    });
});
</script>
{% endblock %} 