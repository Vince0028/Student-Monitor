{% extends 'base.html' %}

{% block title %}Strand Details: {{ strand.name }} - Student Monitor{% endblock %}

{% block content %}
<div class="dashboard-container">
    <h2>{{ strand.name }} Strand ({{ strand.grade_level.name }})</h2>
    <p class="form-subheading">Manage sections within this strand.</p>

    <div class="dashboard-grid">
        <div class="card dashboard-option-card">
            <h3>Sections in {{ strand.name }}</h3>
            <p>View and manage all sections belonging to this strand.</p>
        </div>
        <div class="card dashboard-option-card">
            <h3>Add New Section</h3>
            <p>Create a new section under this strand for {{ strand.grade_level.name }}.</p>
            <a href="{{ url_for('add_section', parent_id=strand.id, parent_type='strand') }}" class="btn btn-primary btn-icon">
                <i class="fas fa-plus-circle"></i> Add Section
            </a>
        </div>
        {# New card for Teacher Assignment Management #}
        <div class="card dashboard-option-card">
            <h3>Teacher Assignment Management</h3>
            <p>Attempt to automatically assign registered teacher accounts to unassigned periods within sections managed by this admin in this strand.</p>
            <button type="button" class="btn btn-primary btn-icon" id="reassignTeachersBtn">
                <i class="fas fa-link"></i> Assign Teachers to Unassigned Periods
            </button>
        </div>
    </div>

    {% if sections %}
    <div class="card mt-40">
        <h3>Section List</h3>
        <div class="table-responsive">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Section Name</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for section in sections %}
                        <tr>
                            <td>{{ section.name }}</td>
                            <td>
                                <div class="button-group">
                                    <a href="{{ url_for('section_details', section_id=section.id) }}" class="btn btn-view btn-icon-small" title="View Section Details">
                                        <i class="fas fa-folder-open"></i> View Details
                                    </a>
                                    <button type="button" class="btn btn-edit btn-icon-small" data-bs-toggle="modal" data-bs-target="#editSectionModal-{{ section.id }}" title="Edit Section">
                                        <i class="fas fa-edit"></i> Edit
                                    </button>
                                    <button type="button" class="btn btn-danger btn-icon-small delete-btn"
                                            data-delete-url="{{ url_for('delete_section_admin', section_id=section.id) }}"
                                            data-redirect-url="{{ url_for('strand_details', strand_id=strand.id) }}"
                                            data-confirmation-message="Are you sure you want to delete section {{ section.name }} and all its periods, students, subjects, attendance, and grades?"
                                            data-item-name="Section {{ section.name }}"
                                            title="Delete Section">
                                        <i class="fas fa-trash-alt"></i> Delete
                                    </button>
                                </div>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% else %}
    <p class="no-data-message">No sections added to {{ strand.name }} Strand yet. Start by adding a new one!</p>
    {% endif %}

    <div class="button-group-right mt-40">
        <a href="{{ url_for('admin_dashboard') }}" class="btn btn-secondary"><i class="fas fa-arrow-left"></i> Back to Grade Level</a>
    </div>
</div>

<!-- Modals for Editing Sections -->
{% for section in sections %}
<div class="modal fade" id="editSectionModal-{{ section.id }}" tabindex="-1" aria-labelledby="editSectionModalLabel-{{ section.id }}" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editSectionModalLabel-{{ section.id }}">Edit Section: {{ section.name }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form action="{{ url_for('edit_section_admin', section_id=section.id) }}" method="POST">
                    <div class="mb-3">
                        <label for="section_name-{{ section.id }}" class="form-label">Section Name</label>
                        <input type="text" class="form-control" id="section_name-{{ section.id }}" name="section_name" value="{{ section.name }}" required>
                    </div>
                    <div class="mb-3">
                        <label for="adviser_name-{{ section.id }}" class="form-label">Adviser Name</label>
                        <input type="text" class="form-control" id="adviser_name-{{ section.id }}" name="adviser_name" value="{{ section.adviser_name or '' }}">
                    </div>
                    <div class="mb-3">
                        <label for="adviser_password-{{ section.id }}" class="form-label">Adviser Password</label>
                        <div style="display: flex; align-items: center;">
                            <input type="password" class="form-control" id="adviser_password-{{ section.id }}" name="adviser_password" value="{{ section.adviser_password or '' }}" placeholder="Set or update the adviser password for this section." style="flex: 1;">
                            <button type="button" onclick="toggleAdviserPasswordVisibility('{{ section.id }}')" style="margin-left: 8px; background: none; border: none; cursor: pointer;" tabindex="-1">
                                <span id="adviserEyeIcon-{{ section.id }}" class="fas fa-eye"></span>
                            </button>
                        </div>
                        <small class="form-hint">Set or update the password for this section. Share it with the adviser.</small>
                    </div>
                    <div class="mb-3">
                        <label for="assigned_user_id-{{ section.id }}" class="form-label">Assign to Account</label>
                        <select class="form-select" id="assigned_user_id-{{ section.id }}" name="assigned_user_id">
                            <option value="">-- Not Assigned --</option>
                            {% for user in section.available_accounts %}
                                <option value="{{ user.id }}" {% if section.assigned_user_id == user.id %}selected{% endif %}>
                                    {{ user.username }} ({{ user.grade_level_assigned }}{% if user.specialization %} - {{ user.specialization }}{% endif %})
                                </option>
                            {% endfor %}
                        </select>
                        <small class="form-hint">Assign this section to a teacher account matching the grade level and strand.</small>
                    </div>
                    <div class="mb-3">
                        <label for="section_password-{{ section.id }}" class="form-label">Section Password</label>
                        <div style="display: flex; align-items: center;">
                            <input type="text" class="form-control" id="section_password-{{ section.id }}" name="section_password" value="{{ section.section_password or '' }}" style="flex: 1;">
                            <button type="button" onclick="toggleSectionPasswordVisibility('{{ section.id }}')" style="margin-left: 8px; background: none; border: none; cursor: pointer;" tabindex="-1">
                                <span id="sectionEyeIcon-{{ section.id }}" class="fas fa-eye"></span>
                            </button>
                        </div>
                        <small class="form-hint">Set or update the password for this section. Share it with the adviser.</small>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endfor %}

{# Add this script section at the very end of your HTML file, before {% endblock %} #}
<script>
    function toggleAdviserPasswordVisibility(sectionId) {
        const input = document.getElementById('adviser_password-' + sectionId);
        const eyeIcon = document.getElementById('adviserEyeIcon-' + sectionId);
        if (input.type === 'password') {
            input.type = 'text';
            eyeIcon.className = 'fas fa-eye-slash';
        } else {
            input.type = 'password';
            eyeIcon.className = 'fas fa-eye';
        }
    }

    function toggleSectionPasswordVisibility(sectionId) {
        const input = document.getElementById('section_password-' + sectionId);
        const eyeIcon = document.getElementById('sectionEyeIcon-' + sectionId);
        if (input.type === 'password' || input.type === 'text') {
            if (input.type === 'password') {
                input.type = 'text';
                eyeIcon.className = 'fas fa-eye-slash';
            } else {
                input.type = 'password';
                eyeIcon.className = 'fas fa-eye';
            }
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        const reassignBtn = document.getElementById('reassignTeachersBtn');
        if (reassignBtn) {
            reassignBtn.addEventListener('click', function() {
                // Show a modal for password confirmation
                showConfirmationModal(
                    'Confirm Teacher Reassignment',
                    'This action will attempt to assign registered teacher accounts to periods that are currently unassigned based on their grade level and specialization. Please enter your password to confirm.',
                    'Confirm Reassignment',
                    (password) => {
                        fetch('{{ url_for("reassign_period_teachers") }}', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/x-www-form-urlencoded',
                            },
                            body: `password=${encodeURIComponent(password)}`
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                // Reload page to reflect changes and show flash message
                                window.location.href = data.redirect_url || '{{ url_for("index") }}';
                            } else {
                                // Stay on page and show error message
                                console.error('Reassignment failed:', data.message);
                                alert(data.message); // Using alert temporarily for quick feedback
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            alert('An unexpected error occurred during reassignment.');
                        });
                    }
                );
            });
        }

        // --- Generic Confirmation Modal (reuse for other deletions/sensitive ops) ---
        // This relies on a modal HTML structure being present in base.html or elsewhere.
        // Assuming you have a basic modal structure with #confirmationModal, #confirmModalText, #confirmModalInput, #confirmModalBtn, #cancelModalBtn
        // If not, you'll need to create one, or use a simpler prompt/confirm.
        function showConfirmationModal(title, message, confirmButtonText, callback) {
            // Placeholder for a proper modal. For now, use prompt for password.
            // In a real app, you'd use a dedicated modal HTML/JS.
            const password = prompt(message + '\n\nPlease enter your password:');
            if (password !== null) { // User clicked OK
                callback(password);
            } else { // User clicked Cancel
                // Do nothing
            }
        }
        // END of Generic Confirmation Modal
    });
</script>
{% endblock %}
